---
title: 'UB55 multivariate analysis: task contrast, group-level'
author: "michael freund"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    highlight: zenburn
    number_sections: true
    theme: spacelab
---


# intro

Purpose: 

1. Validate runwise ub55 GLMs in terms of hi/lo multivairate contrast.
2. Calculate multivariate HiLo conjunction effect and compare to univariate conjunction effect.
    


```{r setup, include = FALSE}

source(here::here("code", "_packages.R"))
source(here("code", "read-behav.R"))
source(here("code", "_vars.R"))
source(here("code", "_atlases.R"))
source(here("code", "_settings.R"))
source(here("code", "_funs.R"))

## data ----

glminfo <- data.frame(
  task = c("Axcpt", "Cuedts", "Stern", "Stroop"),
  name.glm = c(
    "baseline_Cues_EVENTS_censored_shifted", 
    "baseline_CongruencySwitch_EVENTS_censored_shifted",
    "baseline_ListLength_EVENTS_censored_shifted",
    "baseline_Congruency_EVENTS_censored_shifted"
  )
)
glminfo <- as.data.table(glminfo)

weights_t1 <- list(
  Axcpt  = c(AX = 1, AY = 1, Ang = 1, BX = 0, BY = 0, Bng = 0) / 3,
  Cuedts = c(ConInc = 1, ConNoInc = 0, InConInc = 1, InConNoInc = 0) / 2,
  Stern  = c(LL5NP = 1, LL5NN = 1, LL5RN = 1, not5NP = 0, not5NN = 0, not5RN = 0) / 3,
  Stroop = c(PC50Con = 0, PC50InCon = 1, biasCon = 0, PC50InCon = 1) / 2
)

weights_t2 <- list(
  Axcpt  = c(AX = 0, AY = 0, Ang = 0, BX = 1, BY = 1, Bng = 1) / 3,
  Cuedts = c(ConInc = 0, ConNoInc = 1, InConInc = 0, InConNoInc = 1) / 2,
  Stern  = c(LL5NP = 0, LL5NN = 0, LL5RN = 0, not5NP = 1, not5NN = 1, not5RN = 1) / 3,
  Stroop = c(PC50Con = 0, PC50InCon = 1, biasCon = 1, biasInCon = 0) / 2
)



similtype <- c(
  "euclidean-cv-unsta-prewh", "euclidean-cv-stand-prewh", "euclidean-cv-unsta-unpre", "euclidean-cv-stand-unpre"
  )

d <- setNames(vector("list", nrow(glminfo)), glminfo$task)
for (rsa.i in similtype) {
  # rsa.i = similtype[1]
  
  l <- setNames(vector("list", nrow(glminfo)), glminfo$task)
  for (glm.i in seq_len(nrow(glminfo))) {
    # glm.i = 2
    
    a <- readRDS(here("out", "rsa", paste0(rsa.i, "_", glminfo[glm.i]$task, "_", glminfo[glm.i]$name.glm, ".RDS")))
    sds <- apply(a, c("tr", "parcel", "subj"), function(x) sd(x[lower.tri(x)]))
    a <- sweep(a, MARGIN = 3:5, STATS = sds, FUN = "/")
    a <- apply(a, c("tr", "parcel", "subj"), function(x) weights_t2[[glm.i]] %*% x %*% weights_t1[[glm.i]])
    a <- as.data.table(reshape2::melt(a))
    
    a$network <- a$parcel %>% gsub("LH_|RH_", "", .) %>% gsub("_.*", "", .)
    a$hemi <- substr(a$parcel, 1, 1)
    
    l[[glm.i]] <- a
    
  }
  
  d[[rsa.i]] <- bind_rows(l, .id = "task")
  
}

d <- as.data.table(bind_rows(d, .id = "similtype"))
d <- d[subj != "448347"]


facet_labels <- c(
  "euclidean-cv-stand-prewh" = "stand white",
  "euclidean-cv-stand-unpre" = "stand unwhite",
  "euclidean-cv-unsta-prewh" = "unstand white",
  "euclidean-cv-unsta-unpre" = "unstand unwhite" 
)


```



Notes on analyses:


# Network-level

## curves

* Averaged across all conditions (trial types).

```{r network_curves_b, fig.height = 7}

d.network.curves <- d[, .(m = mean(value)), by = .(similtype, task, network, tr, subj)]

for (task.i in tasks) {
  
  p.network.curves  <- d.network.curves %>%
    
    filter(task == task.i) %>%
    mutate(tr = as.numeric(tr)) %>%
    
    ggplot(aes(tr, m)) +
    geom_hline(yintercept = 0) +
    geom_boxplot(width = 0.5, aes(group = tr)) +
    stat_summary(fun.data = "mean_cl_boot", geom = "ribbon", alpha = 1/2) +
    
    facet_grid(
      vars(similtype), vars(network), 
      scale = "free_y", 
      labeller = labeller(similtype = facet_labels)
      ) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    scale_fill_brewer(type = "qual", palette = 2)  +
    
    labs(y = "Mean contrast", x = "TR post stimtime", title = paste0(task.i, ", network level"))
  
  print(p.network.curves)
  
}

```




```{r network_curves_t, fig.height = 7}

d.network.curves.group <- d.network.curves %>%

  group_by(task, tr, network, similtype) %>%
  summarize(
    p = t.test(m)$p.value,
    t = t.test(m)$statistic,
    b = mean(m)
  ) %>%

  group_by(task, tr, similtype) %>%
  mutate(p.fdr = p.adjust(p, "fdr"))


for (task.i in tasks) {
  
  p.network.curves.group <- d.network.curves.group %>%
  
    filter(task == task.i) %>%
  
    mutate(tr = as.numeric(tr)) %>%
  
    ggplot(aes(tr, t, color = similtype, group = similtype)) +
    geom_hline(yintercept = 2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = -2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = 0) +
  
    geom_line(size = 2) +
  
    facet_wrap(vars(network)) +
    scale_color_brewer(type = "qual", palette = 2, labels = facet_labels) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    
    theme(legend.position = c(0.5, 0.15)) +
  
    labs(y = "t statistic", x = "TR post stimtime", title = paste0(task.i, ", DMCC34"))
  
  print(p.network.curves.group)
  
}

```


# parcel-level

```{r}

d.parcel.curves.group <- d %>% 
  .[, 
    .(b = mean(value), t = t.test(value)$statistic, p = t.test(value)$p.value), 
    by = .(similtype, task, parcel, tr)
    ] %>%
  group_by(task, tr, similtype) %>% 
  mutate(p.fdr = p.adjust(p, "fdr"))

```



## curves

```{r}

counts.parcel.curves.group <- d.parcel.curves.group %>%
  
  group_by(task, similtype, tr) %>%
  summarize(
    nparc.activ = sum(b > 0 & p.fdr < 0.05),
    nparc.deactiv = -sum(b < 0 & p.fdr < 0.05)
    ) %>%
  reshape2::melt(id.var = c("task", "tr", "similtype"))


```


### counts of significant effects per TR

```{r}
  
counts.parcel.curves.group %>%
  
  ggplot(aes(as.numeric(tr), value, color = variable)) +
  geom_hline(yintercept = 0) +
  geom_point(size = 2) +
  geom_segment(aes(xend = tr, yend = 0), size = 1) +
  
  facet_grid(vars(similtype), vars(task), labeller = labeller(similtype = facet_labels)) +
  scale_color_brewer(type = "qual", palette = 1) +
  scale_x_continuous(breaks = seq(0, 20, 2)) +
  theme(legend.position = "none") +
  
  labs(
    y = "N parc w/ sig. hilo contrast (FDR corrected whole-cortex)", 
    x = "TR post stimtime", title = "counts of contrast where pFDR < 0.05"
    )

```



### runwise univariate ROIs

```{r}

parcels.univ.conj <- fread(here("out", "conjunction_univ_hilo_target_schaefer400-07.txt"))[[1]]


for (task.i in tasks) {
  
  p.parcel.curves  <- d.parcel.curves.group %>%
    
    filter(task == task.i, parcel %in% parcels.univ.conj) %>%
    mutate(tr = as.numeric(tr)) %>%
    
    ggplot(aes(tr, t, color = similtype, group = similtype)) +
    geom_hline(yintercept = 2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = -2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = 0) +
  
    geom_line(size = 2) +
  
    facet_wrap(vars(parcel)) +
    scale_color_brewer(type = "qual", palette = 2, labels = facet_labels) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    
    theme(legend.position = "top") +
  
    labs(y = "t statistic", x = "TR post stimtime", title = paste0(task.i, ", univariate hilo conjunction"))
  
  print(p.parcel.curves)
  
}


```


### largest 20 ROIs


```{r}

parcels.univ.conj <- fread(here("out", "conjunction_univ_hilo_target_schaefer400-07.txt"))[[1]]


for (task.i in tasks) {
  
  parcels.max20 <- d.parcel.curves.group %>% 
          filter(task == task.i) %>%
          ungroup %>%
          slice_max(order = abs(t), n = 20) %>% pull(parcel) %>% unique
  
  p.parcel.curves  <- d.parcel.curves.group %>% 
    
    filter(task %in% task.i, parcel %in% parcels.max20) %>%
    
    mutate(tr = as.numeric(tr)) %>%
    
    ggplot(aes(tr, t, color = similtype, group = similtype)) +
    geom_hline(yintercept = 2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = -2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = 0) +
  
    geom_line(size = 2) +
  
    facet_wrap(vars(parcel)) +
    scale_color_brewer(type = "qual", palette = 2, labels = facet_labels) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    
    theme(legend.position = "top") +
  
    labs(y = "t statistic", x = "TR post stimtime", title = paste0(task.i, ", 20 parcels with maximum abs(t) stats"))
  
  print(p.parcel.curves)
  
}


```





## maps (cue TRs)



```{r stats}


d.group <- enlist(tasks)
for (task.i in tasks) {
  
  
  d.i <- d[task %in% task.i & tr %in% cue.trs[[task.i]]]
  
  
  l <- split(d.i, interaction(d.i$parcel, d.i$similtype))
  m <- lapply(l, function(x) lmer(value ~ 1 + (1 | subj), x))
  s <- bind_rows(lapply(m, tidy_lmer), .id = "parcel.similtype")
  s <- cbind(s, reshape2::colsplit(s$parcel.similtype, "\\.", c("parcel", "similtype")))
  s %<>% 
    mutate(
      parcel.similtype = NULL,
      term = NULL,
      p.fdr = p.adjust(p.value, "fdr"), 
      network = get.network(parcel),
      hemi = substr(parcel, 1, 1),
      num.roi = match(parcel, parcellation$key)
      )
  
  
  d.group[[task.i]] <- s
  
  
}


lapply(d.group, function(x) filter(x, p.fdr < 0.05 & estimate > 0) %>% nrow)


d.group <- bind_rows(d.group, .id = "task")


fwrite(d.group, here("out", "stats_multiv-euclidean-cv_task_cue_alltasks_schaefer400-07.csv"))


```

Unthresholded and thresholded t-statistics.
Threshold at fdr-corrected p-value (across all parcels) of 0.05.


```{r maps_hilo, fig.height = 7, fig.width = 11, results = "asis"}


for (task.i in tasks) {
  for (similtype.i in similtype) {
    
    
    cat(sprintf("#### %s %s", task.i, similtype.i))
    
    
    d.group %>%
      
      filter(task == task.i, similtype == similtype.i) %>%
      
      build_overlay("statistic", template = schaefer) %>%
      plot_surface(underlay = hcp, hues = viridis::inferno(500))
    
    
    d.group %>%
      
      filter(task == task.i, similtype == similtype.i) %>%
      mutate(statistic = ifelse(p.fdr < 0.05, statistic, 0)) %>%
      
      build_overlay("statistic", template = schaefer) %>%
      plot_surface(underlay = hcp, hues = viridis::inferno(500))

    
  }
}


```


