---
title: 'multitask pattern similarity: high versus low, cross-validated euclidean'
author: "michael freund"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    highlight: zenburn
    number_sections: true
    theme: spacelab
---


# intro


## Purpose

supplementary analysis for jocn 


```{r setup, include = FALSE}

source(here::here("code", "_packages.R"))
source(here("code", "read-behav.R"))
source(here("code", "_vars.R"))
suppressWarnings(source(here("code", "_atlases.R")))
source(here("code", "_settings.R"))
source(here("code", "_funs.R"))

library(ggridges)
library(colorspace)

subjs <- subjs[!subjs %in% "432332"]
conditions <- combo_paste(tasks, c("hi", "lo"))
n.dim <- length(conditions)
is.lower.tri <- lower.tri(diag(n.dim))
tris <- fread(here("out", "multitask", "rsa-model-tris_cross-run.csv")) %>% 
  filter(grepl("run1", .row), grepl("run1", .col))
X <- tris %>% select(where(is.numeric)) %>% as.matrix

rsarray <- readRDS(here("out", "multitask", paste0("euclidean-unbiased_unpre.RDS")))


group.target.trs <- fread(here("out", "stats_univ_hilo_target_schaefer400-07.csv"))
dmcc55b.parcels <- group.target.trs %>% filter(estimate > 0, p.fdr < 0.05) %>% pull(parcel) %>% table
dmcc55b.parcels <- names(dmcc55b.parcels)[dmcc55b.parcels == 4]
 
stats.subjs <- reshape2::melt(rsarray)


theme_mat <- list(theme(axis.text.y = element_text(), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)))


dmcc35 <- c(
  77,78,86,87,88,90,91,99, 101, 103, 105, 110, 127, 130, 132, 139, 140, 141, 148, 172, 175, 185, 189, 290, 306, 311, 
  314, 337, 340, 346, 347, 349, 350
  )
null35 <- c(
  4,5,51,72,97,100,121,122,123,125,150,153,174,211,221,235,244,245,
  266,268,270,272,279,302,304,307,321,323,325,326,330,369,376,381
)


```




# quick look: all correlations

```{r fig.width = 10, fig.height = 7}



p.allcor.density <- stats.subjs %>%
  
  ggplot(aes(value, y = task, fill = task)) +
  geom_density_ridges() +
  
  scale_fill_brewer(type = "qual", palette = 5) +
  
  facet_grid(vars(comparison)) +
  
  theme(legend.position = "none") +
  labs(x = "cv-euclidean")


p.allcor.box <- stats.subjs %>%
  
  ggplot(aes(task, value, fill = task)) +
  geom_hline(yintercept = 0) +
  geom_boxplot(width = 0.1, notch = TRUE) +
  
  scale_fill_brewer(type = "qual", palette = 5) +
  
  theme(legend.position = "none") +
  labs(y = "cor (z)") 



p.allcor.network <- stats.subjs %>%
  
  ggplot(aes(value, y = task, fill = task)) +
  geom_density_ridges() +
  
  scale_fill_brewer(type = "qual", palette = 5) +
  
  facet_grid(
    rows = vars(get.network(parcel)), 
    labeller = labeller(run = c(bt = "between-run", wn = "within-run")),
    scales = "free_x"
    ) +
  
  theme(legend.position = "none") +
  labs(y = "cor (z)")


plot_grid(
  cowplot.title("Pattern correlations by components of RSA model"),
  plot_grid(plot_grid(p.allcor.density, p.allcor.box, ncol = 1), p.allcor.network, nrow = 1),
  ncol = 1, 
  rel_heights = c(0.1, 1)
)


```


# Parcel-wise stats


```{r}

group.contrasts <- stats.subjs %>%
  
  group_by(task, comparison, parcel) %>%
  
  summarize(
    p = wilcox.test(value)$p.value,
    statistic = wilcox.test(value)$statistic,
    b = mean(value),
    .groups = "drop_last"
    ) %>%
  
  group_by(task, comparison) %>%
  
  group_by(p.fdr = p.adjust(p, "fdr"))


group.contrasts %>% filter(p < 0.05, comparison == "run11")

group.contrasts %>% arrange(statistic)


stats.subjs %>%
  
  mutate(network = get.network(parcel)) %>% 
  group_by(task, comparison, network, subj) %>%
  summarize(value = mean(value)) %>%
  
  ggplot(aes(task, value)) +
  
  stat_summary(fun = "mean", geom = "bar", position = position_dodge(width = 1)) +
  stat_summary(fun.data = "mean_cl_boot", geom = "errorbar", position = position_dodge(width = 1), width = 0) +
  facet_grid(vars(network), vars(comparison))


```


* displayed are t statistics
* thresholded images are thesholded at and t > 0 and p < 0.05 FDR corrected across all 400 parcels

```{r, fig.width = 15, results = "asis"}

contrs <- unique(group.contrasts$contrast)


group.contrasts %<>%
  
  mutate(
    hemi = substr(parcel, 1, 1),
    num.roi = match(parcel, parcellation$key)
  ) %>%
  
  arrange(contrast, num.roi)



for (contrs.i in contrs) {
  
  cat("\n ")
  cat(sprintf("\n### %s ", contrs.i))
  cat("\n ")
  
  group.contrasts %>%

    filter(contrast == contrs.i) %>%

    build_overlay("statistic", template = schaefer) %>%
    plot_surface(underlay = hcp, hues = rev(viridis::inferno(500)))


  group.contrasts %>%

    filter(contrast == contrs.i) %>%
    mutate(statistic = ifelse(p.fdr < 0.05 & b > 0, statistic, 0)) %>%

    build_overlay("statistic", template = schaefer) %>%
    plot_surface(underlay = hcp, hues = rev(viridis::inferno(500)))

  
}


```


# DMCC 35 versus null 35


```{r}

contrasts.subjs.35 <-
  contrasts.subjs %>%
  
  filter(parcel %in% parcellation$key[c(dmcc35, null35)], contrast %in% c("hihi_lolo", "hihi_hilo")) %>%
  mutate(
    parcelset = ifelse(parcel %in% parcellation$key[dmcc35], "dmcc35", "null35")
  ) %>%
  
  group_by(subj, contrast, parcelset) %>%
  summarize(b = mean(b))
    
contrasts.subjs.35 %>%    
  group_by(contrast, parcelset) %>%
  summarize(
    p = t.test(b)$p.value,
    statistic = t.test(b)$statistic,
    b = mean(b),
    .groups = "drop_last"
    )

contrasts.subjs.35 %>%
  
  pivot_wider(names_from = "parcelset", values_from = "b") %>%
  group_by(contrast) %>%
  summarize(
    p = t.test(dmcc35, null35, paired = TRUE)$p.value,
    statistic = t.test(dmcc35, null35, paired = TRUE)$statistic,
    b = mean(dmcc35) - mean(null35),
    .groups = "drop_last"
    )


contrasts.subjs.35 %>%
  
  ggplot(aes(contrast, b, fill = parcelset)) +
  
  stat_summary(fun = mean, geom = "bar", position = position_dodge(width = 1)) +
  stat_summary(fun.data = "mean_cl_boot", geom = "errorbar", position = position_dodge(width = 1), width = 0, size = 1) +
  scale_fill_discrete_qualitative() +
  labs(y = "mean contrast on correlations (z)")

```



