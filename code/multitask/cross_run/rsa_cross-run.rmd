---
title: 'multitask RSA: prelim cross-run analysis'
author: "michael freund"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    highlight: zenburn
    number_sections: true
    theme: spacelab
---


# intro

## Purpose

1. Preliminary cross-task RSA: see also https://osf.io/72khu/
2. Assess impact of encoding direction on patterns: systematic bias? magnitude?
3. Help figure out appropriate way(s) to analyze these data for this question.


```{r setup, include = FALSE}

source(here::here("code", "_packages.R"))
source(here("code", "read-behav.R"))
source(here("code", "_vars.R"))
suppressWarnings(source(here("code", "_atlases.R")))
source(here("code", "_settings.R"))
source(here("code", "_funs.R"))

library(ggridges)


subjs <- subjs[!subjs %in% "432332"]
conditions <- combo_paste(tasks, c("hi", "lo"), c("run1", "run2"))
n.dim <- length(conditions)
is.lower.tri <- lower.tri(diag(n.dim))
tris <- fread(here("out", "multitask", "rsa-model-tris_cross-run.csv"))
X <- tris %>% select(where(is.numeric)) %>% as.matrix

rsarray <- readRDS(here("out", "multitask", paste0("corr-biased_unpre.RDS")))


group.target.trs <- fread(here("out", "stats_univ_hilo_target_schaefer400-07.csv"))
dmcc55b.parcels <- group.target.trs %>% filter(estimate > 0, p.fdr < 0.05) %>% pull(parcel) %>% table
dmcc55b.parcels <- names(dmcc55b.parcels)[dmcc55b.parcels == 4]


stats.subjs <- fread(here("out", "multitask",  paste0("subjs_cross-run.csv")))

stats.subjs$run <- ifelse(grepl("^w_", stats.subjs$term), "wn", "bt")
stats.subjs$term <- gsub("^w_|^b_", "", stats.subjs$term)

```



## Notes


**Data/sample/preproc**

  * UB55 sans 432332
  * surface + fMRIprep
  * schaefer 400-07
  
**1st-Level GLM**

  * 1trpk, runwise GLMs, shifted events
  
Target TRs:

  * Axcpt: `r target.trs$Axcpt`
  * Cuedts: `r target.trs$Cuedts`
  * Stern: `r target.trs$Stern`
  * Stroop: `r target.trs$Stroop`

GLM contrasts:

  * Axcpt: $\text{BY} - \text{BX}$
  * Cuedts: $(\text{InConSwitch} + \text{InConRepeat} - \text{ConSwitch} - \text{ConRepeat})/2$
  * Stern: $\text{LL5RN} - \text{LL5NN}$
  * Stroop: $(\text{PC50InCon} + \text{biasInCon} - \text{PC50Con} - \text{biasCon})/2$



**RSA**

Similarity measure:

  * Standard, "vanilla" RSA was used. That is, not a "cross-validated" RSA (e.g., cv-Euclidean, cv-Mahalanobis; Wather et al. 2016).
  * Similarity measure: standard linear correlation
  * NOT cross-valdiated (e.g., not cv-Euclidean/Mahalanobis)
  * NOT prewhitened
  * however, conducted in **BETWEEN-RUN** and **WITHIN-RUN** manner.

Models/Factors:

  * Run/encoding direction: 1/AP, 2/PA
  * Task: Axcpt, ..., Stroop
  * Condition: high, low
  * fit jointly via multiple regression
  * response variable atanh transformed



```{r fig.width = 16}

## build models

rsm.empty <- matrix(0, ncol = n.dim, nrow = n.dim, dimnames = list(conditions, conditions))
rsm.run <- rsm.empty
rsm.task <- rsm.empty
rsm.hi <- rsm.empty
rsm.lo <- rsm.empty

for (task.i in tasks) rsm.task[grepl(task.i, conditions), grepl(task.i, conditions)] <- 1
for (run.i in c("run1", "run2")) rsm.run[grepl(run.i, conditions), grepl(run.i, conditions)] <- 1
rsm.hi[grepl("hi", conditions), grepl("hi", conditions)] <- 1
rsm.lo[grepl("lo", conditions), grepl("lo", conditions)] <- 1


rsm.run.w <- rsm.run
rsm.run.b <- 1 - rsm.run
rsm.task.w <- rsm.run.w * rsm.task
rsm.task.b <- rsm.run.b * rsm.task
rsm.hi.w <- rsm.run.w * rsm.hi
rsm.hi.b <- rsm.run.b * rsm.hi
rsm.lo.w <- rsm.run.w * rsm.lo
rsm.lo.b <- rsm.run.b * rsm.lo
rsm.b0.w <- (1 - (rsm.task | rsm.hi | rsm.lo)) * rsm.run.w
rsm.b0.b <- (1 - (rsm.task | rsm.hi | rsm.lo)) * rsm.run.b


## plot

theme_mat <- list(theme(axis.text.y = element_text(), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)))
title.wn <- ggdraw() +
  draw_label(
    "Within-run RSA models",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

plot_grid(
  title.wn, ncol = 1,
  plot_grid(
    rsm.task.w %>% matplot + theme_mat + labs(title = "task"),
    rsm.hi.w   %>% matplot + theme_mat + labs(title = "condition-high"),
    rsm.lo.w   %>% matplot + theme_mat + labs(title = "condition-low"),
    rsm.b0.w   %>% matplot + theme_mat + labs(title = "intercept"),
    nrow = 1
  ),
  rel_heights = c(0.1, 1)
)

cowplot.title <- function(x) {
  ggdraw() +
  draw_label(
    x,
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )
}


title.bn <- ggdraw() +
  draw_label(
    "Between-run RSA models",
    fontface = 'bold',
    x = 0,
    hjust = 0
  ) +
  theme(
    # add margin on the left of the drawing canvas,
    # so title is aligned with left edge of first plot
    plot.margin = margin(0, 0, 0, 7)
  )

plot_grid(
  title.bn, ncol = 1,
  plot_grid(
    rsm.task.b %>% matplot + theme_mat + labs(title = "task"),
    rsm.hi.b   %>% matplot + theme_mat + labs(title = "condition-high"),
    rsm.lo.b   %>% matplot + theme_mat + labs(title = "condition-low"),
    rsm.b0.b   %>% matplot + theme_mat + labs(title = "intercept"),
    nrow = 1
  ),
  rel_heights = c(0.1, 1)
)


```




**Plotting and statistical details**

  * all p-value corrections were performed whole-cortex, with FDR.
  * inferential tests used wilcoxon-signed rank






# quick look: all correlations

## univariate

```{r fig.width = 10, fig.height = 7}



p.allcor.density <- stats.subjs %>%
  
  ggplot(aes(beta, y = term, fill = term)) +
  geom_density_ridges() +
  
  scale_fill_brewer(type = "qual", palette = 5) +
  
  facet_grid(vars(run), labeller = labeller(run = c(bt = "between-run", wn = "within-run"))) +
  
  theme(legend.position = "none") 
  
  # labs(title = "Density")



p.allcor.box <- stats.subjs %>%
  
  ggplot(aes(term, beta, fill = term)) +
  geom_hline(yintercept = 0) +
  geom_boxplot(width = 0.1, notch = TRUE) +
  
  scale_fill_brewer(type = "qual", palette = 5) +
  
  facet_grid(cols = vars(run), labeller = labeller(run = c(bt = "between-run", wn = "within-run")))  +
  
  theme(legend.position = "none") 
  
  # labs(title = "Boxplot")



p.allcor.network <- stats.subjs %>%
  
  ggplot(aes(beta, y = term, fill = term)) +
  geom_density_ridges() +
  
  scale_fill_brewer(type = "qual", palette = 5) +
  
  facet_grid(
    rows = vars(get.network(parcel)), 
    cols = vars(run), 
    labeller = labeller(run = c(bt = "between-run", wn = "within-run")),
    scales = "free_x"
    ) +
  
  theme(legend.position = "none") 
  # labs(title = "Density by network")



plot_grid(
  cowplot.title("Pattern correlations by components of RSA model"),
  plot_grid(plot_grid(p.allcor.density, p.allcor.box, ncol = 1), p.allcor.network, nrow = 1),
  ncol = 1, 
  rel_heights = c(0.1, 1)
)


```

## bivariate / contrasts of interest

### Between-run models

```{r fig.height = 4, fig.width = 15}


stats.subjs %>%
  
  filter(term == "b0") %>%
  pivot_wider(names_from = "run", values_from = "beta") %>%
  
  ggplot(aes(bt, wn)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  geom_abline(color = "white") +
  geom_hline(yintercept = 0, color = "white") +
  geom_vline(xintercept = 0, color = "white") +
  
  scale_fill_viridis_d(option = "inferno") +

  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "none") +
  
  labs(
    title = "effect of run/encoding direction",
    subtitle = "all correlations between tasks and conditions (hi/lo)",
    x = "between-run intercept",
    y = "within-run intercept"
    ) +
  
  coord_cartesian(xlim = c(-0.15, 0.5), ylim = c(-0.15, 0.5))



stats.subjs %>%
  
  filter(term %in% c("b0", "task"), run == "bt") %>%
  pivot_wider(names_from = "term", values_from = "beta") %>%
  
  ggplot(aes(b0, task)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  geom_abline(color = "white") +
  geom_hline(yintercept = 0, color = "white") +
  geom_vline(xintercept = 0, color = "white") +
  
  scale_fill_viridis_d(option = "inferno") +

  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "none") +
  
  labs(
    title = "effect of task",
    subtitle = "all correlations between runs (1/2) and conditions (hi/lo)",
    x = "between-run intercept",
    y = "within task:\ncor(Axcpt, Axcpt) +, ..., + cor(Stroop, Stroop)"
    ) +
  
  coord_cartesian(xlim = c(-0.15, 0.5), ylim = c(-0.15, 0.5))


stats.subjs %>%
  
  filter(term %in% c("b0", "lo"), run == "bt") %>%
  pivot_wider(names_from = "term", values_from = "beta") %>%
  
  ggplot(aes(b0, lo)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  geom_abline(color = "white") +
  geom_hline(yintercept = 0, color = "white") +
  geom_vline(xintercept = 0, color = "white") +
  
  scale_fill_viridis_d(option = "inferno") +

  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "none") +
  
  labs(
    title = "effect of condition-low",
    subtitle = "all correlations between runs (1/2) and tasks",
    x = "between-run intercept",
    y = "within condition-low:\ncor(low, low)"
    ) +
  
  coord_cartesian(xlim = c(-0.15, 0.5), ylim = c(-0.15, 0.5))



stats.subjs %>%
  
  filter(term %in% c("b0", "hi"), run == "bt") %>%
  pivot_wider(names_from = "term", values_from = "beta") %>%
  
  ggplot(aes(b0, hi)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  geom_abline(color = "white") +
  geom_hline(yintercept = 0, color = "white") +
  geom_vline(xintercept = 0, color = "white") +
  
  scale_fill_viridis_d(option = "inferno") +

  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "none") +
  
  labs(
    title = "effect of condition-high",
    subtitle = "all correlations between runs (1/2) and tasks",
    x = "between-run intercept",
    y = "within condition-high:\ncor(high, high)"
    ) +
  
  coord_cartesian(xlim = c(-0.15, 0.5), ylim = c(-0.15, 0.5))


stats.subjs %>%
  
  filter(term %in% c("lo", "hi"), run == "bt") %>%
  pivot_wider(names_from = "term", values_from = "beta") %>%
  
  ggplot(aes(lo, hi)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  geom_abline(color = "white") +
  geom_hline(yintercept = 0, color = "white") +
  geom_vline(xintercept = 0, color = "white") +
  
  scale_fill_viridis_d(option = "inferno") +

  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "none") +
  
  labs(
    title = "effect of condition-high vs condition-low",
    subtitle = "all correlations between runs (1/2) and tasks",
    x = "within condition-low:\ncor(low, low)",
    y = "within condition-high:\ncor(high, high)"
    ) +
  
  coord_cartesian(xlim = c(-0.15, 0.5), ylim = c(-0.15, 0.5))
  





stats.subjs %>%
  
  filter(term %in% c("task", "hi"), run == "bt") %>%
  pivot_wider(names_from = "term", values_from = "beta") %>%
  
  ggplot(aes(task, hi)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  geom_abline(color = "white") +
  geom_hline(yintercept = 0, color = "white") +
  geom_vline(xintercept = 0, color = "white") +
  
  scale_fill_viridis_d(option = "inferno") +

  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "none") +
  
  labs(
    title = "effect of condition-high vs task",
    subtitle = "all correlations between runs (1/2)",
    x = "within task:\ncor(Axcpt, Axcpt) +, ..., + cor(Stroop, Stroop)",
    y = "within condition-high:\ncor(high, high)"
    ) +
  
  coord_cartesian(xlim = c(-0.15, 0.5), ylim = c(-0.15, 0.5))
  
```



### Within-run models


```{r fig.height = 4, fig.width = 15}


stats.subjs %>%
  
  filter(term %in% c("b0", "task"), run == "wn") %>%
  pivot_wider(names_from = "term", values_from = "beta") %>%
  
  ggplot(aes(b0, task)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  geom_abline(color = "white") +
  geom_hline(yintercept = 0, color = "white") +
  geom_vline(xintercept = 0, color = "white") +
  
  scale_fill_viridis_d(option = "inferno") +

  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "none") +
  
  labs(
    title = "effect of task",
    subtitle = "all correlations between conditions (hi/lo), within run (1/2)",
    x = "within-run intercept",
    y = "within task:\ncor(Axcpt, Axcpt) +, ..., + cor(Stroop, Stroop)"
    )

stats.subjs %>%
  
  filter(term %in% c("b0", "lo"), run == "wn") %>%
  pivot_wider(names_from = "term", values_from = "beta") %>%
  
  ggplot(aes(b0, lo)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  geom_abline(color = "white") +
  geom_hline(yintercept = 0, color = "white") +
  geom_vline(xintercept = 0, color = "white") +
  
  scale_fill_viridis_d(option = "inferno") +

  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "none") +
  
  labs(
    title = "effect of condition-low",
    subtitle = "all correlations between tasks, within run (1/2)",
    x = "within-run intercept",
    y = "within condition-low:\ncor(low, low)"
    ) +
  
  coord_cartesian(xlim = c(-0.15, 0.5), ylim = c(-0.15, 0.5))



stats.subjs %>%
  
  filter(term %in% c("b0", "hi"), run == "wn") %>%
  pivot_wider(names_from = "term", values_from = "beta") %>%
  
  ggplot(aes(b0, hi)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  geom_abline(color = "white") +
  geom_hline(yintercept = 0, color = "white") +
  geom_vline(xintercept = 0, color = "white") +
  
  scale_fill_viridis_d(option = "inferno") +

  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "none") +
  
  labs(
    title = "effect of condition-high",
    subtitle = "all correlations between tasks, within run (1/2)",
    x = "within-run intercept",
    y = "within condition-high:\ncor(high, high)"
    ) +
  
  coord_cartesian(xlim = c(-0.15, 0.5), ylim = c(-0.15, 0.5))


stats.subjs %>%
  
  filter(term %in% c("lo", "hi"), run == "wn") %>%
  pivot_wider(names_from = "term", values_from = "beta") %>%
  
  ggplot(aes(lo, hi)) +
  geom_density_2d_filled(contour_var = "ndensity") +
  geom_abline(color = "white") +
  geom_hline(yintercept = 0, color = "white") +
  geom_vline(xintercept = 0, color = "white") +
  
  scale_fill_viridis_d(option = "inferno") +

  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "none") +
  
  labs(
    title = "effect of condition-high vs condition-low",
    subtitle = "all correlations between tasks, within run (1/2)",
    x = "within condition-low:\ncor(low, low)",
    y = "within condition-high:\ncor(high, high)"
    ) +
  
  coord_cartesian(xlim = c(-0.15, 0.5), ylim = c(-0.15, 0.5))
  


```


# Parcel-wise stats

## bivariate / contrasts of interest


```{r}

contrasts.subjs <- stats.subjs %>%
  
  pivot_wider(names_from = "term", values_from = "beta") %>%
  
  mutate(
    
    task0 = task - b0,
    hi0 = hi - b0,
    lo0 = lo - b0,
    
    hilo = hi - lo,
    hitask = hi - task,
    lotask = lo - task,
    
  ) %>%

  select(-task, -hi, -lo, -b0) %>%
  
  pivot_longer(cols = c("task0", "hi0", "lo0", "hilo", "hitask", "lotask"), names_to = "contrast", values_to = "b")



group.contrasts <- contrasts.subjs %>%
  
  group_by(run, contrast, parcel) %>%
  
  summarize(
    p = wilcox.test(b)$p.value,
    statistic = wilcox.test(b)$statistic,
    b = mean(b),
    .groups = "drop_last"
    ) %>%
  
  group_by(p.fdr = p.adjust(p, "fdr"))





contrast.run.subjs <- stats.subjs %>%
  
  filter(term == "b0") %>%
  pivot_wider(names_from = "run", values_from = "beta") %>%
  
  mutate(run0 = wn - bt)



group.contrast.run <- contrast.run.subjs %>%
  
  group_by(parcel) %>%
  
  summarize(
    p = wilcox.test(run0)$p.value,
    statistic = wilcox.test(run0)$statistic,
    b = mean(run0),
    .groups = "drop_last"
    ) %>%
  
  group_by(p.fdr = p.adjust(p, "fdr"))



```


### Between-run models

```{r fig.height = 4, fig.width = 15}


parcels.run <- group.contrast.run %>% filter(p.fdr < 0.05) %>% pull(parcel)

contrast.run.subjs %>%
  
  group_by(parcel) %>%
  summarize(wn = mean(wn), bt = mean(bt)) %>%
  
  ggplot(aes(bt, wn, fill = parcel %in% parcels.run)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = 3) +
  
  scale_fill_manual(
    values = c("TRUE" = "firebrick1", "FALSE" = "black"), 
    name = NULL, 
    labels = c("TRUE" = "pFDR<0.05", "FALSE" = "pFDR>0.05")
    ) +
  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "top") +
  
  labs(
    title = "effect of run/encoding direction",
    subtitle = "all correlations between tasks and conditions (hi/lo)",
    x = "between-run intercept",
    y = "within-run intercept"
    )






parcels.b.task0 <- group.contrasts %>% filter(run == "bt", contrast == "task0", p.fdr < 0.05) %>% pull(parcel)

stats.subjs %>%
  
  filter(run == "bt") %>%
  group_by(parcel, term) %>%
  summarize(b = mean(beta)) %>%
  
  pivot_wider(names_from = "term", values_from = "b") %>%
  
  ggplot(aes(b0, task, fill = parcel %in% parcels.b.task0)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = 3) +
  
  scale_fill_manual(
    values = c("TRUE" = "firebrick1", "FALSE" = "black"), 
    name = NULL, 
    labels = c("TRUE" = "pFDR<0.05", "FALSE" = "pFDR>0.05")
    ) +
  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "top") +
  
  labs(
    title = "effect of task", 
    subtitle = "all correlations between runs (1/2) and conditions (hi/lo)",
    x = "between-run intercept",
    y = "within task:\ncor(Axcpt, Axcpt) +, ..., + cor(Stroop, Stroop)"
    )




parcels.b.lo0 <- group.contrasts %>% filter(run == "bt", contrast == "lo0", p.fdr < 0.05) %>% pull(parcel)

stats.subjs %>%
  
  filter(run == "bt") %>%
  group_by(parcel, term) %>%
  summarize(b = mean(beta)) %>%
  
  pivot_wider(names_from = "term", values_from = "b") %>%
  
  ggplot(aes(b0, lo, fill = parcel %in% parcels.b.lo0)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = 3) +
  
  scale_fill_manual(
    values = c("TRUE" = "firebrick1", "FALSE" = "black"), 
    name = NULL, 
    labels = c("TRUE" = "pFDR<0.05", "FALSE" = "pFDR>0.05")
    ) +
  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "top") +
  
  labs(
    title = "effect of condition-low", 
    subtitle = "all correlations between runs (1/2) and tasks",
    x = "between-run intercept",
    y = "within condition-low:\ncor(low, low)"
    )









parcels.b.hi0 <- group.contrasts %>% filter(run == "bt", contrast == "hi0", p.fdr < 0.05) %>% pull(parcel)

stats.subjs %>%
  
  filter(run == "bt") %>%
  group_by(parcel, term) %>%
  summarize(b = mean(beta)) %>%
  
  pivot_wider(names_from = "term", values_from = "b") %>%
  
  ggplot(aes(b0, hi, fill = parcel %in% parcels.b.hi0)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = 3) +
  
  scale_fill_manual(
    values = c("TRUE" = "firebrick1", "FALSE" = "black"), 
    name = NULL, 
    labels = c("TRUE" = "pFDR<0.05", "FALSE" = "pFDR>0.05")
    ) +
  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "top") +
  
  labs(
    title = "effect of condition-hi", 
    subtitle = "all correlations between runs (1/2) and tasks",
    x = "between-run intercept",
    y = "within condition-high:\ncor(high, high)"
    )





parcels.b.hilo <- group.contrasts %>% filter(run == "bt", contrast == "hilo", p.fdr < 0.05) %>% pull(parcel)

stats.subjs %>%
  
  filter(run == "bt") %>%
  group_by(parcel, term) %>%
  summarize(b = mean(beta)) %>%
  
  pivot_wider(names_from = "term", values_from = "b") %>%
  
  ggplot(aes(lo, hi, fill = parcel %in% parcels.b.hilo)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = 3) +
  
  scale_fill_manual(
    values = c("TRUE" = "firebrick1", "FALSE" = "black"), 
    name = NULL, 
    labels = c("TRUE" = "pFDR<0.05", "FALSE" = "pFDR>0.05")
    ) +
  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "top") +
  
  labs(
    title = "effect of condition-high vs. condition-low",
    subtitle = "all correlations between runs (1/2) and tasks",
    x = "within condition-low:\ncor(low, low)",
    y = "within condition-high:\ncor(high, high)"
    )




parcels.b.hitask <- group.contrasts %>% filter(run == "bt", contrast == "hitask", p.fdr < 0.05) %>% pull(parcel)

stats.subjs %>%
  
  filter(run == "bt") %>%
  group_by(parcel, term) %>%
  summarize(b = mean(beta)) %>%
  
  pivot_wider(names_from = "term", values_from = "b") %>%
  
  ggplot(aes(task, hi, fill = parcel %in% parcels.b.hitask)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = 3) +
  
  scale_fill_manual(
    values = c("TRUE" = "firebrick1", "FALSE" = "black"), 
    name = NULL, 
    labels = c("TRUE" = "pFDR<0.05", "FALSE" = "pFDR>0.05")
    ) +
  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "top") +
  
  labs(
    title = "effect of condition-high vs. task",
    subtitle = "all correlations between runs (1/2)",
    x = "within task:\ncor(Axcpt, Axcpt) +, ..., + cor(Stroop, Stroop)",
    y = "within condition-high:\ncor(high, high)"
    )


```





### Within-run models

```{r fig.height = 4, fig.width = 15}




parcels.w.task0 <- group.contrasts %>% filter(run == "wn", contrast == "task0", p.fdr < 0.05) %>% pull(parcel)

stats.subjs %>%
  
  filter(run == "wn") %>%
  group_by(parcel, term) %>%
  summarize(b = mean(beta)) %>%
  
  pivot_wider(names_from = "term", values_from = "b") %>%
  
  ggplot(aes(b0, task, fill = parcel %in% parcels.w.task0)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = 3) +
  
  scale_fill_manual(
    values = c("TRUE" = "firebrick1", "FALSE" = "black"), 
    name = NULL, 
    labels = c("TRUE" = "pFDR<0.05", "FALSE" = "pFDR>0.05")
    ) +
  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "top") +
  
  labs(
    title = "effect of task", 
    subtitle = "all correlations within run (1/2), between conditions (hi/lo)",
    x = "within-run intercept (between task, condition)",
    y = "within task:\ncor(Axcpt, Axcpt) +, ..., + cor(Stroop, Stroop)"
    )



parcels.w.lo0 <- group.contrasts %>% filter(run == "wn", contrast == "lo0", p.fdr < 0.05) %>% pull(parcel)

stats.subjs %>%
  
  filter(run == "wn") %>%
  group_by(parcel, term) %>%
  summarize(b = mean(beta)) %>%
  
  pivot_wider(names_from = "term", values_from = "b") %>%
  
  ggplot(aes(b0, hi, fill = parcel %in% parcels.w.lo0)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = 3) +
  
  scale_fill_manual(
    values = c("TRUE" = "firebrick1", "FALSE" = "black"), 
    name = NULL, 
    labels = c("TRUE" = "pFDR<0.05", "FALSE" = "pFDR>0.05")
    ) +
  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "top") +
  
  labs(
    title = "effect of condition-low", 
    subtitle = "all correlations within run (1/2), between tasks",
    x = "within-run intercept (between task, condition)",
    y = "within condition-low:\ncor(low, low)"
    )










parcels.w.hi0 <- group.contrasts %>% filter(run == "wn", contrast == "hi0", p.fdr < 0.05) %>% pull(parcel)

stats.subjs %>%
  
  filter(run == "wn") %>%
  group_by(parcel, term) %>%
  summarize(b = mean(beta)) %>%
  
  pivot_wider(names_from = "term", values_from = "b") %>%
  
  ggplot(aes(b0, hi, fill = parcel %in% parcels.w.hi0)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = 3) +
  
  scale_fill_manual(
    values = c("TRUE" = "firebrick1", "FALSE" = "black"), 
    name = NULL, 
    labels = c("TRUE" = "pFDR<0.05", "FALSE" = "pFDR>0.05")
    ) +
  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "top") +
  
  labs(
    title = "effect of condition-hi", 
    subtitle = "all correlations within run (1/2), between tasks",
    x = "within-run intercept (between task, condition)",
    y = "within condition-high:\ncor(high, high)"
    )





parcels.w.hilo <- group.contrasts %>% filter(run == "wn", contrast == "hilo", p.fdr < 0.05) %>% pull(parcel)

stats.subjs %>%
  
  filter(run == "bt") %>%
  group_by(parcel, term) %>%
  summarize(b = mean(beta)) %>%
  
  pivot_wider(names_from = "term", values_from = "b") %>%
  
  ggplot(aes(lo, hi, fill = parcel %in% parcels.w.hilo)) +
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  geom_point(shape = 21, color = "white", size = 3) +
  
  scale_fill_manual(
    values = c("TRUE" = "firebrick1", "FALSE" = "black"), 
    name = NULL, 
    labels = c("TRUE" = "pFDR<0.05", "FALSE" = "pFDR>0.05")
    ) +
  facet_grid(cols = vars(get.network(parcel)), scales = "free") +
  
  theme(legend.position = "top") +
  
  labs(
    title = "effect of condition-high vs. condition-low",
    subtitle = "all correlations within run (1/2), between tasks",
    x = "within condition-low:\ncor(low, low)",
    y = "within condition-high:\ncor(high, high)"
    )


```



## brains

```{r, fig.width = 15, results = "asis"}

rsas <- c("wn", "bt")
contrs <- unique(group.contrasts$contrast)


group.contrasts %<>%
  
  mutate(
    hemi = substr(parcel, 1, 1),
    num.roi = match(parcel, parcellation$key)
  ) %>%
  
  arrange(run, contrast, num.roi)



for (rsa.i in rsas) {
  
  cat("\n ")
  cat(sprintf("\n### %s ", rsa.i))
  cat("\n ")
  
  for (contrs.i in contrs) {
    
    cat("\n ")
    cat(sprintf("\n#### %s ", contrs.i))
    cat("\n ")
    
    group.contrasts %>%

      filter(run == rsa.i, contrast == contrs.i) %>%

      build_overlay("statistic", template = schaefer) %>%
      plot_surface(underlay = hcp, hues = rev(viridis::inferno(500)))


    group.contrasts %>%

      filter(run == rsa.i, contrast == contrs.i) %>%
      mutate(statistic = ifelse(p.fdr < 0.05, statistic, 0)) %>%

      build_overlay("statistic", template = schaefer) %>%
      plot_surface(underlay = hcp, hues = rev(viridis::inferno(500)))

    
  }
  
}




```

