---
title: 'multitask RSA: prelim cross-run analysis'
author: "michael freund"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    highlight: zenburn
    number_sections: true
    theme: spacelab
---



```{r setup, include = FALSE}

source(here::here("code", "_packages.R"))
source(here("code", "read-behav.R"))
source(here("code", "_vars.R"))
suppressWarnings(source(here("code", "_atlases.R")))
source(here("code", "_settings.R"))
source(here("code", "_funs.R"))

library(ggridges)


subjs <- subjs[!subjs %in% "432332"]
conditions <- combo_paste(tasks, c("hi", "lo"), c("run1", "run2"))
n.dim <- length(conditions)
is.lower.tri <- lower.tri(diag(n.dim))
tris <- fread(here("out", "multitask", "rsa-model-tris_cross-run.csv"))
X <- tris %>% select(where(is.numeric)) %>% as.matrix

rsarray <- readRDS(here("out", "multitask", paste0("corr-biased_unpre.RDS")))


group.target.trs <- fread(here("out", "stats_univ_hilo_target_schaefer400-07.csv"))
dmcc55b.parcels <- group.target.trs %>% filter(estimate > 0, p.fdr < 0.05) %>% pull(parcel) %>% table
dmcc55b.parcels <- names(dmcc55b.parcels)[dmcc55b.parcels == 4]


stats.subjs <- fread(here("out", "multitask",  paste0("subjs_cross-run.csv")))

stats.subjs$run <- ifelse(grepl("^w_", stats.subjs$term), "wn", "bt")
stats.subjs$term <- gsub("^w_|^b_", "", stats.subjs$term)

theme_mat <- list(theme(axis.text.y = element_text(), axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)))


```



# Notes


**Data/sample/preproc**

  * UB55 sans 432332
  * surface + fMRIprep
  * schaefer 400-07
  
**1st-Level GLM**

  * 1trpk, runwise GLMs, shifted events
  
Target TRs:

  * Axcpt: `r target.trs$Axcpt`
  * Cuedts: `r target.trs$Cuedts`
  * Stern: `r target.trs$Stern`
  * Stroop: `r target.trs$Stroop`

GLM contrasts:

  * Axcpt: $\text{BY} - \text{BX}$
  * Cuedts: $(\text{InConSwitch} + \text{InConRepeat} - \text{ConSwitch} - \text{ConRepeat})/2$
  * Stern: $\text{LL5RN} - \text{LL5NN}$
  * Stroop: $(\text{PC50InCon} + \text{biasInCon} - \text{PC50Con} - \text{biasCon})/2$



**RSA**

Similarity measure:

  * Standard, "vanilla" RSA was used. That is, not a "cross-validated" RSA (e.g., cv-Euclidean, cv-Mahalanobis; Wather et al. 2016).
  * Similarity measure: standard linear correlation
  * NOT cross-valdiated (e.g., not cv-Euclidean/Mahalanobis)
  * NOT prewhitened
  * however, conducted in **BETWEEN-RUN** and **WITHIN-RUN** manner.



```{r fig.width = 16, fig.height = 4.5}

## build models

rsm.empty <- matrix(0, ncol = n.dim, nrow = n.dim, dimnames = list(conditions, conditions))
rsm.run <- rsm.empty
rsm.task <- rsm.empty
rsm.hi <- rsm.empty
rsm.lo <- rsm.empty

for (task.i in tasks) rsm.task[grepl(task.i, conditions), grepl(task.i, conditions)] <- 1
for (run.i in c("run1", "run2")) rsm.run[grepl(run.i, conditions), grepl(run.i, conditions)] <- 1
rsm.hi[grepl("hi", conditions), grepl("hi", conditions)] <- 1
rsm.lo[grepl("lo", conditions), grepl("lo", conditions)] <- 1


rsm.run.w <- rsm.run
rsm.run.b <- 1 - rsm.run
rsm.task.w <- rsm.run.w * rsm.task
rsm.task.b <- rsm.run.b * rsm.task
rsm.hi.w <- rsm.run.w * rsm.hi
rsm.hi.b <- rsm.run.b * rsm.hi
rsm.lo.w <- rsm.run.w * rsm.lo
rsm.lo.b <- rsm.run.b * rsm.lo
rsm.b0.w <- (1 - (rsm.task | rsm.hi | rsm.lo)) * rsm.run.w
rsm.b0.b <- (1 - (rsm.task | rsm.hi | rsm.lo)) * rsm.run.b


## plot

plot_grid(
  cowplot.title("Within-run RSA models"), ncol = 1,
  plot_grid(
    rsm.task.w %>% matplot + theme_mat + labs(title = "task"),
    rsm.hi.w   %>% matplot + theme_mat + labs(title = "condition-high"),
    rsm.lo.w   %>% matplot + theme_mat + labs(title = "condition-low"),
    rsm.b0.w   %>% matplot + theme_mat + labs(title = "intercept"),
    nrow = 1
  ),
  rel_heights = c(0.1, 1)
)


plot_grid(
  cowplot.title("Between-run RSA models"), ncol = 1,
  plot_grid(
    rsm.task.b %>% matplot + theme_mat + labs(title = "task"),
    rsm.hi.b   %>% matplot + theme_mat + labs(title = "condition-high"),
    rsm.lo.b   %>% matplot + theme_mat + labs(title = "condition-low"),
    rsm.b0.b   %>% matplot + theme_mat + labs(title = "intercept"),
    nrow = 1
  ),
  rel_heights = c(0.1, 1)
)


```


# Group-mean similarity matrices

## full matrix (within and between runs)

```{r fig.width = 16, fig.height = 4}


n.col  <- 4

vp <- viewport(
  layout = grid.layout(
    nrow = 1, 
    ncol = n.col, 
    widths = unit(rep(4, n.col), "in"), 
    heights = unit(4, "in")
  )
)



R_bar <- tanh(apply(atanh(rsarray), c(".row", ".col", "parcel"), mean))

for (parcel.i in seq_along(parcellation$key)) {
  
  col.i <- parcel.i %% n.col
  if (col.i == 0) col.i <- n.col
  if (col.i == 1) pushViewport(vp)
  
  pushViewport(viewport(layout.pos.col = col.i, layout.pos.row = 1))
  
  p <-
    R_bar[, , parcel.i] %>% matplot + 
      theme_mat + 
      labs(title = parcellation$key[parcel.i])
    
  grid.draw(ggplotGrob(p))
  
  
  popViewport()
  
  if (col.i == n.col) grid.newpage()
  
}


```



## between-run only



```{r fig.width = 16, fig.height = 4}


n.col  <- 4

vp <- viewport(
  layout = grid.layout(
    nrow = 1, 
    ncol = n.col, 
    widths = unit(rep(4, n.col), "in"), 
    heights = unit(4, "in")
  )
)


R_bar_b <- R_bar[grep("run1", dimnames(R_bar)$.row), grep("run2", dimnames(R_bar)$.col), ]

for (parcel.i in seq_along(parcellation$key)) {
  
  col.i <- parcel.i %% n.col
  if (col.i == 0) col.i <- n.col
  if (col.i == 1) pushViewport(vp)
  
  pushViewport(viewport(layout.pos.col = col.i, layout.pos.row = 1))
  
  p <-
    R_bar_b[, , parcel.i] %>% matplot + 
      theme_mat + 
      labs(title = parcellation$key[parcel.i]) +
      geom_text(aes(label = round(value, 1)*10), size = 4, color = "grey50")
    
  grid.draw(ggplotGrob(p))
  
  
  popViewport()
  
  if (col.i == n.col) grid.newpage()
  
}


```
