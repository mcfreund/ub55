---
title: 'UB55 trialwise univariate analysis: Stroop hi-lo contrast, group-level'
author: "michael freund"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    highlight: zenburn
    number_sections: true
    theme: spacelab
---


# intro

## Purpose

1. Validate trialwise ub55 Stroop GLM high-vs-low contrast.
2. Explore methods of modeling trial-wise parcel-mean beta estimates.
    


```{r setup, include = FALSE}


source(here::here("code", "_packages.R"))
source(here("code", "read-behav.R"))
source(here("code", "_vars.R"))
source(here("code", "_atlases.R"))
source(here("code", "_settings.R"))
source(here("code", "_funs.R"))

## data ----

glminfo <- data.frame(
  task = c("Stroop"),
  name.glm = c(
    "baseline_fix-LSA_EVENTS_censored"
  )
)
glminfo <- as.data.table(glminfo)

d <- setNames(vector("list", nrow(glminfo)), glminfo$task)
for (glm.i in seq_len(nrow(glminfo))) {
  # glm.i = 1
  
  a <- readRDS(here("out", "glms", paste0("roistats_", glminfo[glm.i]$task, "_", glminfo[glm.i]$name.glm, ".RDS")))
  a <- a[, , subjs[!subjs %in% "432332"], ]
  a <- as.data.table(reshape2::melt(a))
  
  a <- separate(a, term, c("term", "stat"), "_")
  a <- a[!grepl("Full|block", term) & stat == "Coef"]
  a <- separate(a, term, c("term", "n"), "#")
  
  a$network <- a$parcel %>% gsub("LH_|RH_", "", .) %>% gsub("_.*", "", .)
  a$hemi <- substr(a$parcel, 1, 1)
  
  if (!identical(unique(a$stat), "Coef")) stop("more stats than coef in there")

  a$stat <- NULL
  a <- rename(a, b = value)
  
  d[[glm.i]] <- a
  
}
rm(glm.i, a)
gc()



## bind and create data.tables suitable for looping

d <- bind_rows(d, .id = "task")


```




## Notes on analyses

**GLMs**

  * DMCC55B
  * trialwise LS-A, fix-shaped BLOCK(1,1), Stroop


**Contrasts (on regional means):**

  * Stroop: $(\text{PC50InCon} + \text{biasInCon} - \text{PC50Con} - \text{biasCon})/2$


**Plotting and statistical details:**




# quick look

## raw data

```{r fig.width = 16}

p.density <- d %>%
  
  ggplot(aes(b, term, fill = term)) +
  geom_density_ridges() +
  
  scale_fill_brewer(type = "qual", palette = 5) +
  
  facet_grid(vars(run)) +
  
  theme(legend.position = "none") 



p.box <-  d %>%
  
  ggplot(aes(term, b, fill = term)) +
  geom_hline(yintercept = 0) +
  geom_boxplot(width = 0.5, outlier.size = 0.5) +
  
  scale_fill_brewer(type = "qual", palette = 5) +
  
  facet_grid(vars(run))  +
  
  theme(legend.position = "none") +
  coord_flip()




p.network <- d %>%
  
  ggplot(aes(term, b, fill = term)) +
  geom_hline(yintercept = 0) +
  geom_boxplot(width = 0.5, outlier.size = 0.5) +

  
  scale_fill_brewer(type = "qual", palette = 5) +
  
  facet_grid(
    rows = vars(get.network(parcel)), 
    cols = vars(run), 
    scales = "free_x"
    ) +
  
  theme(legend.position = "none") +
  coord_flip()



plot_grid(
  
  cowplot.title("Beta estimates by trialtype"),
  
  plot_grid(plot_grid(p.density, p.box, ncol = 1), p.network, nrow = 1),
  
  ncol = 1, rel_heights = c(0.1, 1)
  
)



```


# prelim models



```{r}

## contrast matrix:

A <- rbind(
  bias_stroop = c(-1, 1, 0, 0),
  pc50_stroop = c(0, 0, -1, 1),
  stroop      = c(-1, 1, 0, 0),
  pc50_bias   = c(1, 1, -1, -1) / 2
)
# detectCores()/2


## fit models

l <- split(d, d$parcel)
m0 <- mclapply(l, function(x) lmer(b ~ 0 + term + (0 + term  | subj), x), mc.cores = n.cores / 2)


## contrast coefficients

h0 <- mclapply(m0, function(x) multcomp::glht(x, A), mc.cores = n.cores / 2)
h0 <- mclapply(
  h0, 
  function(x) {
    
    a <- summary(x, test = adjusted("none"))$test
    
    data.table(
      estimate = a$coefficients,
      se = a$sigma,
      statistic = a$tstat,
      p.value = a$pvalue,
      term = names(a$coefficients)
    )

    },
  
  mc.cores = n.cores / 2
  
)

stats.group.m0 <- rbindlist(h0, idcol = "parcel")

stats.group.m0 %<>%
  group_by(term) %>%
  mutate(
    p.fdr = p.adjust(p.value, "fdr"),
    hemi = substr(parcel, 1, 1),
    num.roi = row_number()
    )





stats.group.m0 %>% filter(estimate > 0 & p.fdr < 0.05, term == "stroop")


```




## Brains

* t-values displayed; from HLM fitted to TR-level data (see intro)
* colors are reversed (black = high, yellow = low) so large positive effects can be seen on white underlay.


```{r brains, fig.width = 15, results = "asis"}



for (term.i in rownames(A)) {
  # term.i = "stroop"
  
  cat("\n ")
  cat(sprintf("\n### %s ", term.i))
  cat("\n ")

  
  stats.group.m0 %>%
    
    filter(term == term.i) %>%
    arrange(num.roi) %>%
    
    build_overlay("statistic", template = schaefer) %>%
    plot_surface(underlay = hcp, hues = rev(viridis::inferno(500)))
  
  
  stats.group.m0 %>%
    
    filter(term == term.i) %>%
    arrange(num.roi) %>%
    
    mutate(statistic = ifelse(p.fdr < 0.05, statistic, 0)) %>%
    
    build_overlay("statistic", template = schaefer) %>%
    plot_surface(underlay = hcp, hues = rev(viridis::inferno(500)))

    
}



```



```{r}

# fwrite(group.target.trs, here("out", "stats_univ_hilo_target_schaefer400-07.csv"))

```






```{r}
# 
# # group.target.trs <- fread(here("out", "stats_univ_hilo_target_schaefer400-07.csv"))
# 
# parcel.order <- group.target.trs %>%
#   
#   filter(parcel %in% dmcc55b.parcels) %>%
#   
#   group_by(parcel) %>%
#   summarize(b = mean(estimate)) %>%
#   arrange(-b) %>%
#   pull(parcel)
# 
# group.target.trs %>%
#   
#   filter(parcel %in% dmcc55b.parcels) %>%
#   
#   ggplot(aes(factor(parcel, levels = parcel.order), estimate, color = task)) +
#   
#   geom_line(aes(group = task), size = 2) +
#   geom_point(size = 2.5) +
#   geom_errorbar(
#     aes(ymax = estimate + se*1.96, ymin = estimate - se*1.96), width = 0, size = 2
#     ) +
#   
#   scale_color_brewer(type = "qual", palette = 7) +
#   # scale_x_discrete()
#   
#   theme(
#     axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), legend.position = "top"
#     ) +
#   
#   labs(x = NULL, y = "contrast estimate")
# 
# 
# group.target.trs %>%
#   
#   filter(parcel %in% dmcc55b.parcels) %>%
#   
#   group_by(task) %>%
#   mutate(estimate = scale(estimate)) %>%
#   
#   ggplot(aes(factor(parcel, levels = parcel.order), estimate, color = task)) +
#   
#   geom_line(aes(group = task), size = 2) +
#   geom_point(size = 2.5) +
#   # geom_errorbar(aes(ymax = estimate + se*1.96, ymin = estimate - se*1.96), width = 0) +
#   
#   scale_color_brewer(type = "qual", palette = 7) +
#   
#   theme(
#     axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), legend.position = "top"
#     ) +
#   
#   labs(x = NULL, y = "z-scored contrast estimate")
# 


```












