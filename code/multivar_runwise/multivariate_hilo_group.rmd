---
title: 'UB55 multivariate analysis: hi-lo contrast, group-level'
author: "michael freund"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    highlight: zenburn
    number_sections: true
    theme: spacelab
---


# intro

Purpose: 

1. Preliminary look at hi/lo multivariate contrast (cross-validated euclidean) in each task.
2. Preliminary qualitative comparison of effects of prewhitening and pattern standardization on multivariate contrast.
    


```{r setup, include = FALSE}

source(here::here("code", "_packages.R"))
source(here("code", "read-behav.R"))
source(here("code", "_vars.R"))
source(here("code", "_atlases.R"))
source(here("code", "_settings.R"))
source(here("code", "_funs.R"))

## data ----

glminfo <- data.frame(
  task = c("Axcpt", "Cuedts", "Stern", "Stroop"),
  name.glm = c(
    "baseline_Cues_EVENTS_censored_shifted", 
    "baseline_CongruencySwitch_EVENTS_censored_shifted",
    "baseline_ListLength_EVENTS_censored_shifted",
    "baseline_Congruency_EVENTS_censored_shifted"
  )
)
glminfo <- as.data.table(glminfo)

weights_hi <- list(
  Axcpt  = c(AX = 0, AY = 0, Ang = 0, BX = 1, BY = 0, Bng = 0),
  Cuedts = c(ConInc = 0, ConNoInc = 0, InConInc = 1, InConNoInc = 1) / 2,
  Stern  = c(LL5NP = 0, LL5NN = 0, LL5RN = 1, not5NP = 0, not5NN = 0, not5RN = 0),
  Stroop = c(PC50Con = 0, PC50InCon = 1, biasCon = 0, PC50InCon = 1) / 2
)

weights_lo <- list(
  Axcpt  = c(AX = 0, AY = 0, Ang = 0, BX = 0, BY = 1, Bng = 0),
  Cuedts = c(ConInc = 1, ConNoInc = 1, InConInc = 0, InConNoInc = 0) / 2,
  Stern  = c(LL5NP = 0, LL5NN = 1, LL5RN = 0, not5NP = 0, not5NN = 0, not5RN = 0),
  Stroop = c(PC50Con = 1, PC50InCon = 0, biasCon = 1, biasInCon = 0) / 2
)



similtype <- c(
  # "euclidean-cv-unsta-prewh", "euclidean-cv-stand-prewh", "euclidean-cv-unsta-unpre", "euclidean-cv-stand-unpre"
  "euclidean-cv-unsta-prewh", "euclidean-cv-unsta-unpre"
  )

d <- setNames(vector("list", nrow(glminfo)), glminfo$task)
for (rsa.i in similtype) {
  # rsa.i = similtype[1]
  
  l <- setNames(vector("list", nrow(glminfo)), glminfo$task)
  for (glm.i in seq_len(nrow(glminfo))) {
    # glm.i = 4
    
    a <- readRDS(here("out", "rsa", paste0(rsa.i, "_", glminfo[glm.i]$task, "_", glminfo[glm.i]$name.glm, ".RDS")))
    
    ## standardize each RDM by the sd of unique off-diagonals:
    sds <- apply(a, c("tr", "parcel", "subj"), function(x) sd(x[lower.tri(x)]))
    a <- sweep(a, MARGIN = 3:5, STATS = sds, FUN = "/")
    
    ## apply contrast:
    a <- apply(a, c("tr", "parcel", "subj"), function(x) weights_lo[[glm.i]] %*% x %*% weights_hi[[glm.i]])
    a <- as.data.table(reshape2::melt(a))
    
    a$network <- a$parcel %>% gsub("LH_|RH_", "", .) %>% gsub("_.*", "", .)
    a$hemi <- substr(a$parcel, 1, 1)
    
    l[[glm.i]] <- a
    
  }
  
  d[[rsa.i]] <- bind_rows(l, .id = "task")
  
}

d <- as.data.table(bind_rows(d, .id = "similtype"))
d <- d[subj != "448347"]


facet_labels <- c(
  # "euclidean-cv-stand-prewh" = "stand white",
  # "euclidean-cv-stand-unpre" = "stand unwhite",
  "euclidean-cv-unsta-prewh" = "whitened",
  "euclidean-cv-unsta-unpre" = "unwhitened" 
)

group.target.trs <- fread(here("out", "stats_univ_hilo_target_schaefer400-07.csv"))
dmcc55b.parcels <- group.target.trs %>% filter(estimate > 0, p.fdr < 0.05) %>% pull(parcel) %>% table
dmcc55b.parcels <- names(dmcc55b.parcels)[dmcc55b.parcels == 4]


colors.transform <- c(whitened = "#d73027", unwhitened = "#4575b4")

d[similtype == "euclidean-cv-unsta-prewh"]$similtype <- "whitened"
d[similtype == "euclidean-cv-unsta-unpre"]$similtype <- "unwhitened"
```



Notes on analyses:

Target TRs:

  * Axcpt: `r target.trs$Axcpt`
  * Cuedts: `r target.trs$Cuedts`
  * Stern: `r target.trs$Stern`
  * Stroop: `r target.trs$Stroop`

Contrasts (cross-validated euclidean):

  * Axcpt: $\text{BY} - \text{BX}$
  * Cuedts: $(\text{InConSwitch} + \text{InConRepeat} - \text{ConSwitch} - \text{ConRepeat})/2$
  * Stern: $\text{LL5RN} - \text{LL5NN}$
  * Stroop: $(\text{PC50InCon} + \text{biasInCon} - \text{PC50Con} - \text{biasCon})/2$

Transformations:

  * "whitened": spatially pre-whitened cross-validated euclidean ('mahalanobis')
    * using vertex-by-vertex inverse covariance matrix derived from residual timeseries
  * "unwhitened": not spatially pre-whitened
  * all results considered here use *unstandardized* euclidean distance (i.e., patterns are not z-score normalized).
  
Plotting and statistical details:

  * within 'curves' sections, ribbons indicate 95% CI of bootstrapped mean beta across subjects (one ribbon per run).
  * all p-value corrections were performed whole-cortex, with FDR.
  * for "stats and maps" sections, HLM was used to estimate t-statistics on the hi-lo contrast per ROI:
      * random-intercept models
      * level-I: (TR within target window)\*(run)
      * level-2: subject
      * $\beta_{ts} = b_0 + d_s + \epsilon_{trs}$
        * $\beta_{ts} is HiLo contrast per subject, tr
        * $t, s$ are indices for TR, and subject
        * $d$ is is subject-specific intercept
        * $\epsilon$ is error



# Network-level contrasts

Estimates are first averaged across parcels within network per subject.
Group-level stats and plots are then displayed at the network-level.

## beta estimates

```{r network_curves_b, fig.height = 8}


for (task.i in tasks) {
  
  
  p.network.b <- d[task == task.i, .(b = mean(value)), by = .(similtype, network, tr, subj)] %>%  ## average across parcels
    
    mutate(tr = as.numeric(tr)) %>%
    
    ggplot(aes(tr, b, fill = similtype)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", geom = "ribbon", alpha = 0.9) +
    
    facet_grid(vars(network), vars(similtype)) +
    scale_fill_manual(values = colors.transform) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    
    labs(y = "Mean beta", x = "TR post stimtime", title = paste0(task.i)) +
    theme(legend.position = "top")
  
  print(p.network.b)
  
  
}

```


### t-stats

```{r network_curves_t, fig.height = 8}

d.network.group <- d[, .(b = mean(value)), by = .(task, similtype, network, tr, subj)] %>%

  group_by(task, tr, network, similtype) %>%
  summarize(
    p = t.test(b)$p.value,
    t = t.test(b)$statistic,
    b = mean(b)
  ) %>%

  group_by(task, tr, similtype) %>%
  mutate(p.fdr = p.adjust(p, "fdr"))


for (task.i in tasks) {
  
  p.network.curves.group <- d.network.group %>%
  
    filter(task == task.i) %>%
  
    mutate(tr = as.numeric(tr)) %>%
  
    ggplot(aes(tr, t, color = similtype, group = similtype)) +
    geom_hline(yintercept = 2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = -2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = 0) +
  
    geom_line(size = 2) +
  
    facet_wrap(vars(network)) +
    scale_color_manual(values = colors.transform) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    
    theme(legend.position = c(0.5, 0.15)) +
  
    labs(y = "t statistic on contrast", x = "TR post stimtime", title = task.i)
  
  print(p.network.curves.group)
  
}

```


# Parcel-level contrasts

```{r}

d.parcel.curves.group <- d %>% 
  .[, 
    .(b = mean(value), t = t.test(value)$statistic, p = t.test(value)$p.value), 
    by = .(similtype, task, parcel, tr)
    ] %>%
  group_by(task, tr, similtype) %>% 
  mutate(p.fdr = p.adjust(p, "fdr"))

```

## counts of significant effects per TR

Using t-test of subject parcel means.


```{r}

counts.parcel.curves.group <- d.parcel.curves.group %>%
  
  group_by(task, similtype, tr) %>%
  summarize(
    nparc.activ = sum(b > 0 & p.fdr < 0.05),
    nparc.deactiv = -sum(b < 0 & p.fdr < 0.05)
    ) %>%
  reshape2::melt(id.var = c("task", "tr", "similtype"))


```


```{r, fig.height = 7}
  
counts.parcel.curves.group %>%
  
  ggplot(aes(as.numeric(tr), value, color = variable)) +
  geom_hline(yintercept = 0) +
  geom_point(size = 2) +
  geom_segment(aes(xend = tr, yend = 0), size = 1) +
  
  facet_grid(vars(similtype), vars(task)) +
  scale_color_brewer(type = "qual", palette = 1) +
  scale_x_continuous(breaks = seq(0, 20, 4)) +
  theme(legend.position = "none") +
  
  labs(
    y = "N parc w/ sig. hilo contrast (FDR corrected whole-cortex)", 
    x = "TR post stimtime", title = "counts of contrast where pFDR < 0.05"
    )

```



## DMCC55B univariate ROIs
Curves for conjunction ROIs defined in univariate_group.rmd.

### beta estimates

```{r parcel_contrasts_dmcc55b_betas, fig.height = 12, fig.width = 15}


for (task.i in tasks) {
  
  
  p.contrast.parcel.b.dmcc55b <- 
    
    d[
      task == task.i & parcel %in% dmcc55b.parcels,
      .(b = mean(value)), by = .(similtype, parcel, tr, subj)
      ] %>%
    
    mutate(tr = as.numeric(tr)) %>%
    
    ggplot(aes(tr, b, fill = similtype)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", geom = "ribbon", alpha = 0.9) +
    
    facet_wrap(vars(parcel)) +
    scale_fill_manual(values = colors.transform) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +

    labs(y = "Mean conrast", x = "TR post stimtime", title = task.i) +
    theme(legend.position = "top")
  
  print(p.contrast.parcel.b.dmcc55b)

  
}


```


### t-statistics

```{r parcel_contrasts_dmcc55b_tstats, fig.height = 12, fig.width = 15}



for (task.i in tasks) {
  
  
  p.contrast.parcel.t <- 
    
    d.parcel.curves.group %>% 
    
    filter(task == task.i, parcel %in% dmcc55b.parcels) %>%
    
    ggplot(aes(tr, t, color = similtype)) +
    geom_hline(yintercept = 2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = -2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = 0) +
  
    geom_line(size = 2) +
  
    facet_wrap(vars(parcel)) +
    scale_color_manual(values = colors.transform) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    
    theme(legend.position = "top") +
    labs(x = "TR post stimtime", y = "t-statistic of contrast", title = task.i)
  
  
  print(p.contrast.parcel.t)

  
}


```


## DMCC55B multivariate ROIs: Cross-task conjunction

Here conjunction analysis is performed by feeding TR-level contrast estimates to an HLM (see description at beginning of doc).

Number of parcels identified, and parcel names:

```{r parcelwise_stats}



group.target.trs <- enlist(tasks)
for (task.i in tasks) {
  
  
  d.task <- d[task == task.i & tr %in% target.trs[[task.i]]]
  d.task <- split(d.task, interaction(d.task$parcel, d.task$similtype))
  
  m.task <- lapply(d.task, function(x) lmer(value ~ 1 + (1 | subj), x))
  
  s.task <- bind_rows(lapply(m.task, tidy_lmer), .id = "parcel")
  
  s.task <- cbind(
      s.task %>% select(-parcel),
      reshape2::colsplit(s.task$parcel, "\\.", c("parcel", "similtype"))
    )

  s.task %<>%
    
    select(-term) %>% 
    
    group_by(similtype) %>%
    mutate(
      p.fdr = p.adjust(p.value, "fdr"),
      hemi = substr(parcel, 1, 1),
      num.roi = row_number()
      )
  
  group.target.trs[[task.i]] <- s.task
  
}

group.target.trs <- bind_rows(group.target.trs, .id = "task")

fwrite(group.target.trs, here("out", "stats_multiv-euclidean-cv_hilo_target_alltasks_schaefer400-07.csv"))


dmcc55b.multi.parcels.unwhitened <- group.target.trs %>%
  filter(estimate > 0, p.fdr < 0.05, similtype == "unwhitened") %>% 
  pull(parcel) %>% 
  table
dmcc55b.multi.parcels.unwhitened <- names(dmcc55b.multi.parcels.unwhitened)[dmcc55b.multi.parcels.unwhitened > 1]

dmcc55b.multi.parcels.whitened <- group.target.trs %>%
  filter(estimate > 0, p.fdr < 0.05, similtype == "whitened") %>% 
  pull(parcel) %>% 
  table
dmcc55b.multi.parcels.whitened <- names(dmcc55b.multi.parcels.whitened)[dmcc55b.multi.parcels.whitened > 1]

dmcc55b.multi.parcels <- intersect(dmcc55b.multi.parcels.unwhitened, dmcc55b.multi.parcels.whitened)
```


* No parcels ID'd (pFDR<0.05) in all four tasks in either whitened or non-whitened measures.
* Parcels ID'd in =>2 tasks with unwhitened: `r dmcc55b.multi.parcels.unwhitened`
* Parcels ID'd in =>2 tasks with whitened: `r dmcc55b.multi.parcels.whitened`


### intersection of parcels ID'd by unwhitened and whitened measures in =>2 tasks




### beta estimates

```{r parcel_contrasts_dmcc55b_mv_betas, fig.height = 12, fig.width = 15}


for (task.i in tasks) {
  
  
  p.contrast.parcel.b.dmcc55b.mv <- 
    
    d[
      task == task.i & parcel %in% dmcc55b.multi.parcels,
      .(b = mean(value)), by = .(similtype, parcel, tr, subj)
      ] %>%
    
    mutate(tr = as.numeric(tr)) %>%
    
    ggplot(aes(tr, b, fill = similtype)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", geom = "ribbon", alpha = 0.9) +
    
    facet_wrap(vars(parcel)) +
    scale_fill_manual(values = colors.transform) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +

    labs(y = "Mean conrast", x = "TR post stimtime", title = task.i) +
    theme(legend.position = "top")
  
  print(p.contrast.parcel.b.dmcc55b.mv)

  
}


```


### t-statistics

```{r parcel_contrasts_dmcc55b_mv_tstats, fig.height = 12, fig.width = 15}



for (task.i in tasks) {
  
  
  p.contrast.parcel.t <- 
    
    d.parcel.curves.group %>% 
    
    filter(task == task.i, parcel %in% dmcc55b.multi.parcels) %>%
    
    ggplot(aes(tr, t, color = similtype)) +
    geom_hline(yintercept = 2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = -2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = 0) +
  
    geom_line(size = 2) +
  
    facet_wrap(vars(parcel)) +
    scale_color_manual(values = colors.transform) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    
    theme(legend.position = "top") +
    labs(x = "TR post stimtime", y = "t-statistic of contrast", title = task.i)
  
  
  print(p.contrast.parcel.t)

  
}


```




## all parcels

```{r}

group.target.trs %>%
  
  select(task, statistic, p.fdr, parcel, similtype) %>%
  as.data.table %>%
  dcast(task + parcel ~ similtype, value.var = c("statistic", "p.fdr")) %>%
  
  ggplot(aes(statistic_whitened, statistic_unwhitened)) +
  
  geom_abline() +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  
  geom_point(aes(fill = p.fdr_whitened < 0.05 | p.fdr_unwhitened < 0.05), shape = 21, color = "white") +
  
  facet_grid(cols = vars(task)) +
  scale_fill_manual(
    values = c("TRUE" = "firebrick1", "FALSE" = "black"), 
    labels = c("pFDR<0.05", "pFDR>0.05"), 
    name = NULL
    ) +
  
  theme(legend.position = "top") +
  labs(
    title = "test statistics from whitened versus unwhitened contrasts", 
    x = "t stat whitened", 
    y = "t stat unwhitened"
    )



```



## maps (target TRs)


Unthresholded and thresholded t-statistics displayed on inflated brains.
Threshold at fdr-corrected p-value (across all parcels) of 0.05.
Note: colors are reverse-scaled, i.e., dark == strong effect, light == weak effect (so strong effects show up on white background).

```{r maps_hilo, fig.width = 15, results = "asis"}


for (task.i in tasks) {
  
  cat("\n ")
  cat(sprintf("\n### %s ", task.i))
  cat("\n ")
  for (similtype.i in similtype) {
    
    cat("\n ")
    cat(sprintf("\n#### %s ", facet_labels[similtype.i == names(facet_labels)]))
    cat("\n ")
    
    group.target.trs %>%
      
      filter(task == task.i, similtype == similtype.i) %>%
      
      build_overlay("statistic", template = schaefer) %>%
      plot_surface(underlay = hcp, hues = rev(viridis::inferno(500)))
    
    
    group.target.trs %>%
      
      filter(task == task.i, similtype == similtype.i) %>%
      mutate(statistic = ifelse(p.fdr < 0.05, statistic, 0)) %>%
      
      build_overlay("statistic", template = schaefer) %>%
      plot_surface(underlay = hcp, hues = rev(viridis::inferno(500)))

    
  }
}


```


