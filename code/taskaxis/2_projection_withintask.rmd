---
title: 'task axis projection: within-task, TR-wise'
author: "michael freund"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    highlight: zenburn
    number_sections: true
    theme: spacelab
params:
  prew: vanilla
  glmt: 'null'
  resi: errts

---


# intro

* projections etc:
  * within task, both cross and within-run
  * network-level (schaefer 400 surfaces)
* spatial prewhitening: `r params$prew`
* GLM for residuals: `r params$glm`
* residual types: `r params$resi`


## Purpose


```{r setup, include = FALSE}

## for rendering
if (FALSE) {
  
  render_report <- function(prew, glmt, resi) {
    
    # https://stackoverflow.com/questions/28500096/r-markdown-variable-output-name

    rmarkdown::render(
      "2_projection_withintask.Rmd",
      params = list(
        prew = prew,
        glmt = glmt,
        resi = resi
      ),
      output_file = paste0(
        "2_projection_withintask_parc-network_",
        "prew-", prew, "_glm-", glmt, "_resi-", resi,
        ".html"
        )
    )
  }
  
  # render_report(prew = "vanilla", glmt = "noblock", resi = "errts")
  # params <- list(prew = "vanilla", glmt = "noblock", resi = "errts")
  
}


source(here::here("code", "_packages.R"))
source(here("code", "read-behav.R"))
source(here("code", "_vars.R"))
source(here("code", "_atlases.R"))
source(here("code", "_settings.R"))
source(here("code", "_funs.R"))


subjs <- subjs[!subjs %in% c("432332", "DMCC5820265")]


## design matrices:

X <- enlist(tasks)
X$Axcpt  <- readRDS(here("out", "glms", "xmats_Axcpt_baseline_Cues_EVENTS_censored_shifted.RDS"))
X$Cuedts <- readRDS(here("out", "glms", "xmats_Cuedts_baseline_CongruencySwitch_EVENTS_censored_shifted.RDS"))
X$Stern  <- readRDS(here("out", "glms", "xmats_Stern_baseline_ListLength_EVENTS_censored_shifted.RDS"))
X$Stroop <- readRDS(here("out", "glms", "xmats_Stroop_baseline_Congruency_EVENTS_censored_shifted.RDS"))

X <- map(X, ~.[, , subjs, ])  ## get good subjs

x <- lapply(X, reshape2::melt)


## projection time-series:

A <- enlist(tasks)
for (name.task.i in tasks) {
  
  A[[name.task.i]] <- readRDS( 
    here(
      "out", "taskaxis", 
      paste0(
        "projections_task-", name.task.i, 
        "_parc-network_", 
        "prew-", params$prew, "_glm-", params$glmt, "_resi-", params$resi, ".RDS"
        )
      )
    )[, , , subjs]
  
}

a <- lapply(A, reshape2::melt)


## combine:

for (name.task.i in tasks) {
  
    x_i <- dcast(as.data.table(x[[name.task.i]]), tr + subj + run ~ regressor)
    a_i <- a[[name.task.i]]
    
    a_i$run <- paste0("run", substr(a_i$fold, 3, 3))  ## make run col to bind with
    
    a[[name.task.i]] <- as.data.table(full_join(a_i, x_i, by = c("tr", "subj", "run")))
    
}


## misc:

group.target.trs <- fread(here("out", "stats_univ_hilo_target_schaefer400-07.csv"))
dmcc55b.parcels <- group.target.trs %>% filter(estimate > 0, p.fdr < 0.05) %>% pull(parcel) %>% table
dmcc55b.parcels <- names(dmcc55b.parcels)[dmcc55b.parcels == 4]


n.subj <- length(subjs)
set.seed(0)
rsubj <- sample.int(n.subj, 10)



```


## time-series


```{r, fig.height = 8, fig.width = 12, results = "asis"}


for (name.task.i in tasks) {
  # name.task.i = "Axcpt"
  
  cat("\n")
  cat(sprintf("\n### %s", name.task.i))
  cat("\n")
  
  
  ## group level
  
  a_i <- a[[name.task.i]][
    , .(value = mean(value, na.rm = TRUE), block = mean(`block#0`)), 
    by = c("tr", "roi", "fold")
    ]
  
  ## get TRs of block onset and offset
  
  block.reg <- a_i[, .(block = mean(block)), by = "tr"]$block
  is.block.change <- abs(diff(abs(diff(block.reg)) > 0.05)) != 0  ## large change in 2nd deriv (onset of ON and OFF)
  tr.block.change <- which(c(FALSE, is.block.change))
  
  
  ## carpet plots
  
  p.w <- a_i %>%
    
    filter(fold %in% c("1_1", "2_2")) %>%

    ggplot(aes(tr, roi)) +
    
    geom_tile(aes(fill = value)) +
    geom_vline(xintercept = tr.block.change, color = "white", size = 1) +
    
    scale_fill_viridis_c(option = "inferno") +
    facet_grid(rows = vars(fold), labeller = labeller(fold = c("1_1" = "run 1", "2_2" = "run 2"))) +
    
    labs(title = paste0(name.task.i, " within-run")) +
    theme(legend.position = "top")
  
  print(p.w)
  
  
  p.c <- a_i %>%
    
    filter(fold %in% c("1_2", "2_1")) %>%
  
    ggplot(aes(tr, roi)) +
    
    geom_tile(aes(fill = value)) +
    geom_vline(xintercept = tr.block.change, color = "white", size = 1) +
    
    scale_fill_viridis_c(option = "inferno") +
    facet_grid(rows = vars(fold), labeller = labeller(fold = c("1_2" = "run 2", "2_1" = "run 1"))) +
    
    labs(title = paste0(name.task.i, " cross-run")) +
    theme(legend.position = "top")
  
  print(p.c)
  
  
  ## line plots

  p.mu <- a_i %>%
    
    filter(fold %in% c("1_2", "2_1")) %>%
  
    ggplot(aes(tr, value)) +
    
    geom_vline(xintercept = tr.block.change, color = "grey70") +
    geom_hline(yintercept = 0, color = "grey70") +
    geom_line(aes(color = roi, group = fold), size = 1) +
    # geom_line(data = . %>% .[, .(block = mean(block)), by = "tr"], aes(y = block * 5), size = 1) +
    
    facet_grid(rows = vars(roi)) +
    
    labs(title = paste0(name.task.i, " cross-run"), caption = "line per run") +
    theme(legend.position = "none")
  
  print(p.mu)
  
  
  p.ci <- a[[name.task.i]] %>%
    
    filter(fold %in% c("1_2", "2_1")) %>%
  
    ggplot(aes(tr, value)) +
    
    geom_vline(xintercept = tr.block.change, color = "grey70") +
    geom_hline(yintercept = 0, color = "grey70") +
    stat_summary(aes(fill = roi, group = fold), fun.data = mean_cl_boot, geom = "ribbon", alpha = 0.5) +

    facet_grid(rows = vars(roi)) +
    
    labs(title = paste0(name.task.i, " 95%CI, cross-run"), caption = "ribbon per run") +
    theme(legend.position = "none")
  
  print(p.ci)
  
  
  p.t <- a[[name.task.i]] %>%
    
    filter(fold %in% c("1_2", "2_1")) %>%
  
    ggplot(aes(tr, value)) +
    
    geom_vline(xintercept = tr.block.change, color = "grey70") +
    geom_hline(yintercept = 0, color = "grey70") +
    stat_summary(aes(color = roi, group = fold), fun = ~t.test(.)$statistic, geom = "line", size = 1) +
    
    facet_grid(rows = vars(roi)) +
    
    labs(title = paste0(name.task.i, " t stat, cross-run"), caption = "ribbon per run") +
    theme(legend.position = "none")
  
  print(p.t)
  
  
  
  for (roi.i in unique(get.network(parcellation$key))) {
    
    
    p.roi <- a[[name.task.i]] %>%
    
      filter(fold %in% c("1_2", "2_1"), roi == roi.i) %>%
    
      ggplot(aes(tr, value)) +
      
      geom_vline(xintercept = tr.block.change, color = "grey70") +
      geom_hline(yintercept = 0, color = "grey70") +
      geom_line(aes(group = subj), alpha = 0.25) +
      stat_summary(fun = mean, geom = "line", size = 1, color = "white") +
      
      facet_grid(rows = vars(fold), labeller = labeller(fold = c("1_2" = "run 2", "2_1" = "run 1"))) +
      
      labs(title = paste0(roi.i, " ", name.task.i, " subjects, cross-run"))
    
    print(p.roi)
    
    
  }
  
  ## subj-level
  
  p.subj <-
    a[[name.task.i]] %>%
      
      filter(subj %in% subjs[rsubj], roi == "DorsAttn", fold %in% c("1_2", "2_1")) %>%
  
      ggplot(aes(tr, value)) +
      
      geom_hline(yintercept = 0, color = "grey70") +
      geom_line(aes(group = subj, color = subj), size = 1) +
    
      facet_grid(rows = vars(subj), cols = vars(run))
  
  plot(p.subj)
  
    
}



```


```{r, include = FALSE}

## oscillations

onsets.axcpt <- table(
  a$Axcpt$tr, 
  rowSums(a$Axcpt[, c("AX#0", "AY#0", "BX#0", "BY#0", "Ang#0", "Bng#0")]) > 0.99
  ) %>%
  as.data.frame %>%
  filter(Var2 == TRUE) %>% pull(Freq)

plot(onsets.axcpt)
lines(onsets.axcpt)
  
# a[[name.task.i]] %>%
# 
#   filter(fold %in% c("1_2", "2_1"), roi == "DorsAttn") %>%
# 
#   ggplot(aes(tr, value)) +
#   
#   # geom_vline(xintercept = tr.block.change, color = "grey70") +
#   geom_hline(yintercept = 0, color = "grey70") +
#   stat_summary(aes(color = roi), fun = ~t.test(.)$statistic, geom = "line", size = 1) +
#   geom_line(
#     data = data.frame(y = onsets.axcpt / max(onsets.axcpt), x = 1:length(onsets.axcpt)),
#     aes(y = y, x = x)
#     )
#   
  # # facet_grid(rows = vars(roi)) +
  # theme_bw() +
  # scale_x_continuous(n.breaks = 25) +
  # coord_cartesian(xlim = c(50, 80))


```



## time-aggregated


```{r, fig.height = 8, fig.width = 12, results = "asis"}


lmfit <- function(.) {
  
  i <- which(.$is.included > 0)
  j <- -grep("movregs|Run|included|tr|roi|subj|fold|value|run", names(.))

  .x <- as.matrix(cbind(1, .[i, j]))
  .y <- .$value[i]

  b <- coef(.lm.fit(x = .x, y = .y))

  data.frame(b, term = c("b0", names(.)[j]))
  
}



for (name.task.i in tasks) {
  # name.task.i = "Axcpt"
  
  cat("\n")
  cat(sprintf("\n### %s", name.task.i))
  cat("\n")
  
  
  a_cross <- a[[name.task.i]][fold %in% c("1_2", "2_1")]  ## cros-run only
  
  
  ## fit model on projections
  
  a_i <- a_cross %>%
    
    group_by(subj, roi, fold) %>%
    
    nest %>%
    
    mutate(new = map(data, lmfit)) %>% 
    
    select(-data) %>% unnest(cols = c(new))
  
  a_i$event.type <- gsub("#[0-9]*", "", a_i$term)
  a_i$knot <- gsub("b0|block#0|.*#([0-9]*)", "\\1", a_i$term)
  
  
  ## plot coefficients
  
  p.block <- a_i %>%
    
    filter(event.type %in% c("block", "b0")) %>%
    group_by(subj, roi, term, event.type, knot) %>%
    summarize(b = mean(b)) %>%
  
    ggplot(aes(roi, b)) +
    
    geom_hline(yintercept = 0) +
    stat_summary(
      aes(color = event.type), fun.data = mean_cl_boot, position = position_dodge(width = 0.25),
      size = 1
      ) +
    
    scale_color_discrete_qualitative() +
    
    labs(title = paste0(name.task.i, " block coefs, cross-run"))

  
  print(p.block)
  
  
  p.event <-  a_i %>%
    
    filter(!event.type %in% c("b0", "block")) %>%
    group_by(subj, roi, term, event.type, knot) %>%
    summarize(b = mean(b)) %>%
  
    ggplot(aes(as.numeric(knot), b)) +
    
    geom_hline(yintercept = 0) +
    stat_summary(aes(color = roi), fun.data = mean_cl_boot) +
    
    facet_grid(rows = vars(event.type), cols = vars(roi)) +
    
    labs(title = paste0(name.task.i, " event coefs, cross-run"))
  
  
  print(p.event)
  
  ## by num. 'active' TRs
  
  j <- -grep("movregs|Run|included|tr|roi|subj|fold|value|run|block#0", names(a_cross))
  a_cross$n.active.tr <- round(rowSums(a_cross[, ..j]))
  
  a_active <- a_cross[, .(value = mean(value)), by = c("subj", "roi", "fold", "n.active.tr")]
  
  p.active <- a_active %>%
    
    ggplot(aes(n.active.tr, value)) +
    
    geom_hline(yintercept = 0) +
    stat_summary(aes(color = roi), fun.data = mean_cl_boot) +
    
    facet_grid(cols = vars(roi)) +
    
    labs(title = paste0(name.task.i, " cross-run"), x = "number of concurrently 'active' regressors") +
    theme(legend.position = "none")
  
  print(p.active)
  
  t.active <- kable(
    table(a_cross$n.active.tr, a_cross$`block#0` > 0) / nrow(a_cross) * 100,
    col.names = c("block<=0", "block>0"),
    caption = "percentage of TRs by number of concurrently 'active' event regressors in rest (block<=0) and task (block>0)"
    )
  
  print(t.active)
  
}


```


## decoding analysis

* cutpoints
* exclusion of run and block on/off boundaries

```{r}

## estimate cutpoints

cutpoint <- function(.x, run) {
  # .x <- a[[name.task.i]][roi == "Vis" & subj == "102008"]
  # .x <- a_i[subj == subj.i & roi == roi.i]
  
  f <- paste0(run, "_", run)
  .x <- .x[fold == f, ]
  
  ## exclude block and run boundaries
  
  
  .x <- .x[!tr %in% exclude, ]
  
  .x$block <- .x$`block#0` > 0.999    ## get task versus rest
  
  mean(.x[, .(value = mean(value)), by = block]$value)
  
}


for (name.task.i in tasks) {
  # name.task.i = "Axcpt"
  
  a_i <- a[[name.task.i]]
  
  ## exclude TRs
  
  from <- unique(a_i[`blockONandOFF#0` > 0.99]$tr)
  to <- unique(a_i[`blockONandOFF#12` > 0.99]$tr)
  if (length(from) != length(to)) stop("bad blockONandOFF.")
  exclude <- vector("list", length(from))
  for (ii in seq_along(from)) exclude[[ii]] <- from[ii]:to[ii]  ## block boundaries
  exclude <- c(unlist(exclude), c(1:6, ((n.trs[name.task.i]/2)-6):(n.trs[name.task.i] / 2)))  ## run boundaries
  
  a_i <- a_i[!tr %in% exclude, ]
  
  a_i$block <- ifelse(a_i$`block#0` > 0.999, "task", "rest")    ## get task versus rest
  
  
  ## get mean of means
  
  means <- a_i[fold %in% c("1_1", "2_2") & is.included == 1, .(value = mean(value)), by = .(block, subj, roi, fold)]
  cuts <- means[, .(cutpoint = mean(value)), by = .(subj, roi, fold)]
  cuts$fold <- ifelse(cuts$fold == "1_1", "1_2", "2_1")  ## switch fold to bind
  
  a_cross <- a_i[is.included == 1 & fold %in% c("1_2", "2_1"), ]  ## on cross-validated data
  
  a_cross <- full_join(a_cross, cuts, by = c("subj", "roi", "fold"))
  
  a_cross$value.c <- a_cross$value - a_cross$cutpoint  ## center timecourse at cutpoint
  
  
  p.cutp.diff <- a_cross %>%
    
    group_by(subj, roi, block) %>%
    summarize(value.c = mean(value.c)) %>%
    
    pivot_wider(names_from = block, values_from = value.c) %>%
    mutate(proj = task - rest) %>%
    
    ggplot(aes(roi, proj)) +
    
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = mean_cl_boot) +
    
    labs(
      title = paste0(name.task.i, " cross-run projection"), 
      x = "schaefer network"
      )
  
  print(p.cutp.diff)
  
  
  p.cutp.means <- a_cross %>%
    
    group_by(subj, roi, block) %>%
    summarize(proj = mean(value.c)) %>%
    
    ggplot(aes(roi, proj, color = block)) +
    
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = mean_cl_boot, position = position_dodge(width = 0.25)) +
    
    labs(
      title = paste0(name.task.i, " cross-run projection, w/ est. cutpoint"), 
      x = "schaefer network"
      )
  
  print(p.cutp.means)  
  
  
  p.cutp.t <- a_cross %>%

    ggplot(aes(tr, value.c)) +
    
    geom_hline(yintercept = 0, color = "grey70") +
    stat_summary(aes(color = roi), fun = ~t.test(.)$statistic, geom = "point", size = 1) +
    
    facet_grid(rows = vars(roi)) +
    
    labs(title = paste0(name.task.i, " t stat, cross-run, w/ est. cutpoint")) +
    theme(legend.position = "none")
  
  print(p.cutp.t)
  
  p.cutp.subj <- a_cross %>%
        
    filter(subj %in% subjs[rsubj], roi == "DorsAttn", fold %in% c("1_2", "2_1")) %>%

    ggplot(aes(tr, value.c)) +
    
    geom_hline(yintercept = 0, color = "grey70") +
    geom_point(aes(group = subj, color = subj), size = 1) +
  
    facet_grid(rows = vars(subj), cols = vars(run), scales = "free_y") +
    theme(legend.position = "none")
  
  print(p.cutp.subj)
  

}


```
