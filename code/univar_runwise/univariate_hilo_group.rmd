---
title: 'UB55 univariate analysis: hi-lo contrast, group-level'
author: "michael freund"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    highlight: zenburn
    number_sections: true
    theme: spacelab
---


# intro

Purpose: 

1. Validate runwise ub55 GLMs in terms of marginal HRFs (averaged across conditions) and high-vs-low contrast.
2. Define target TRs for each task.
3. Calculate HiLo conjunction effect, and create list of conjunction parcels.
    


```{r setup, include = FALSE}


source(here::here("code", "_packages.R"))
source(here("code", "read-behav.R"))
source(here("code", "_vars.R"))
source(here("code", "_atlases.R"))
source(here("code", "_settings.R"))
source(here("code", "_funs.R"))

## data ----

glminfo <- data.frame(
  task = c("Axcpt", "Cuedts", "Stern", "Stroop"),
  name.glm = c(
    "baseline_Cues_EVENTS_censored_shifted", 
    "baseline_CongruencySwitch_EVENTS_censored_shifted",
    "baseline_ListLength_EVENTS_censored_shifted",
    "baseline_Congruency_EVENTS_censored_shifted"
  )
)
glminfo <- as.data.table(glminfo)

d <- setNames(vector("list", nrow(glminfo)), glminfo$task)
for (glm.i in seq_len(nrow(glminfo))) {
  # glm.i = 1
  
  a <- readRDS(here("out", "glms", paste0("roistats_", glminfo[glm.i]$task, "_", glminfo[glm.i]$name.glm, ".RDS")))
  a <- a[, , subjs[!subjs %in% "432332"], ]
  a <- as.data.table(reshape2::melt(a))
  
  a <- separate(a, term, c("term", "stat"), "_")
  a <- a[!grepl("Full|block", term) & stat == "Coef"]
  a <- separate(a, term, c("term", "tr"), "#")
  
  a$network <- a$parcel %>% gsub("LH_|RH_", "", .) %>% gsub("_.*", "", .)
  a$hemi <- substr(a$parcel, 1, 1)
  
  if (!identical(unique(a$stat), "Coef")) stop("more stats than coef in there")
  # a <- dcast(a, term + tr + parcel + subj + run + hemi + network ~ stat, value.var = "value")
  # names(a) <- tolower(names(a))
  
  a$stat <- NULL
  a <- rename(a, b = value)
  
  d[[glm.i]] <- a
  
}
rm(glm.i, a)
gc()

## fix cuedts labels: incorrect! (mislabeled in afni code)
d$Cuedts$term <- gsub("NoInc$", "Repeat", d$Cuedts$term)
d$Cuedts$term <- gsub("Inc$", "Switch", d$Cuedts$term)


## bind and create data.tables suitable for looping

d <- bind_rows(d, .id = "task")
d.marginal <- d[, .(b = mean(b)), by = .(task, run, network, parcel, tr, subj)]  ## average across conditions
d.contrast <- rbind(
  
  d[task == "Axcpt" & term %in% c("BX", "BY"), ] %>%
    dcast(... ~ term, value.var = "b") %>%
    mutate(b = BX - BY) %>% select(-BX, -BY),
  
  d[task == "Cuedts"] %>% 
    dcast(... ~ term, value.var = "b") %>%
    mutate(b = (InConSwitch + InConRepeat - ConSwitch - ConRepeat)/2, tr = as.numeric(tr)) %>% 
    select(-InConSwitch, -InConRepeat, -ConSwitch, -ConRepeat),
  
  d[task == "Stern" & term %in% c("LL5RN", "LL5NN")] %>%
    dcast(... ~ term, value.var = "b") %>%
    mutate(b = LL5RN - LL5NN, tr = as.numeric(tr)) %>%
    select(-LL5NN, -LL5RN),
  
  d[task == "Stroop"] %>%
    dcast(... ~ term, value.var = "b") %>%  
    mutate(b = (biasInCon + PC50InCon - biasCon - PC50Con)/2, tr = as.numeric(tr)) %>%
    select(-biasInCon, -PC50InCon, -biasCon, -PC50Con)

)

```




Notes on analyses:

GLMs:

  * DMCC55B
  * run-wise, 1trpk, shifted TENTs
  * Cuedts: terms for $\text{trial-type (congr, incon)}\times\text{sequence (switch, repeat)}$ instead of $\text{incentive}$


Target TRs:

  * Axcpt: `r target.trs$Axcpt`
  * Cuedts: `r target.trs$Cuedts`
  * Stern: `r target.trs$Stern`
  * Stroop: `r target.trs$Stroop` 
  * Axcpt, Cuedts, and Stern begins at roughly ~4 TRs post-cue onset, and ending at ~8 TRs post-cue onset
  * Stroop begins at 2 TRs post-target onset, ends at 6 TRs post-target onset

Contrasts (on regional means):

  * Axcpt: $\text{BY} - \text{BX}$
  * Cuedts: $(\text{InConSwitch} + \text{InConRepeat} - \text{ConSwitch} - \text{ConRepeat})/2$
  * Stern: $\text{LL5RN} - \text{LL5NN}$
  * Stroop: $(\text{PC50InCon} + \text{biasInCon} - \text{PC50Con} - \text{biasCon})/2$

Plotting and statistical details:

  * within 'curves' sections, ribbons indicate 95% CI of bootstrapped mean beta across subjects (one ribbon per run).
  * all p-value corrections were performed whole-cortex, with FDR.
  * for "stats and maps" sections, HLM was used to estimate t-statistics on the hi-lo contrast per ROI:
      * random-intercept models
      * level-I: (TR within target window)\*(run)
      * level-2: subject
      * $\beta_{trs} = b_0 + d_s + \epsilon_{trs}$
        * $\beta_{trs}$ is high-low contrast beta estimate
        * $t, r, s$ are indices for TR, run, and subject
        * $d$ is is subject-specific intercept
        * $\epsilon$ is error





# Network-level

Estimates are first averaged across parcels within network per subject.
Group-level stats and plots are then displayed at the network-level.

## marginal beta estimates (averaged across all trialtypes)


```{r network_marginal, fig.height = 8, results = "asis"}


for (task.i in tasks) {
  
  
  p.marginal <- d.marginal[task == task.i, .(b = mean(b)), by = .(run, network, tr, subj)] %>%  ## average across parcels
    
    mutate(tr = as.numeric(tr)) %>%
    
    ggplot(aes(tr, b, fill = run)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", geom = "ribbon", alpha = 0.9) +
    
    facet_grid(vars(network), vars(run)) +
    scale_fill_brewer(type = "qual", palette = 2) +
    scale_x_continuous(breaks = seq(0, 20, 2)) +
    
    labs(y = "Mean beta", x = "TR post stimtime", title = paste0(task.i)) +
    theme(legend.position = "top")
  
  print(p.marginal)
  
  
  
  p.marginal.bivar <- d.marginal[task == task.i, .(b = mean(b)), by = .(run, network, tr, subj)] %>%  ## average across parcels
    
    dcast(... ~ run, value.var = "b") %>%
    
    ggplot(aes(run1, run2)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(shape = 21, fill = "black", color = "white", size = 2) +
    geom_point(
      data = . %>% group_by(network, tr) %>% summarize(run1 = mean(run1), run2 = mean(run2)),
      size = 2,
      color = "firebrick1"
      ) +
    
    scale_x_continuous(n.breaks = 4) +
    scale_y_continuous(n.breaks = 4) +
    
    facet_grid(vars(as.numeric(tr)), vars(network), scales = "free") +
    labs(x = "run1 Mean beta", y = "run2 Mean beta", title = task.i) +
    theme(legend.position = "top")
  
  subchunkify(p.marginal.bivar, fig_height = 20, fig_width = 12)
  
  
}


```



## conditional (per trialtype)



```{r network_conditional, fig.height = 7, fig.width = 8}


for (task.i in tasks) {
  
  
  p.network.conditional <- d[task == task.i, .(b = mean(b)), by = .(run, network, tr, subj, term)] %>%
    
    mutate(tr = as.numeric(tr)) %>%
    
    ggplot(aes(tr, b, fill = run)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", geom = "ribbon", alpha = 2/3) +
    
    facet_grid(vars(network), vars(term)) +
    scale_fill_brewer(type = "qual", palette = 2) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
  
    labs(y = "Mean beta", x = "TR post stimtime", title = task.i) +
    theme(legend.position = "none")
  
  print(p.network.conditional)
  
  
}


```


## contrasts

### beta estimates

```{r network_contrasts_betas, fig.height = 7, results = "asis"}


for (task.i in tasks) {
  
  
  p.contrast <- d.contrast[task == task.i, .(b = mean(b)), by = .(run, network, tr, subj)] %>%
    
    mutate(tr = as.numeric(tr)) %>%
    
    ggplot(aes(tr, b, fill = run)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", geom = "ribbon", alpha = 0.9) +
    
    facet_grid(vars(network), vars(run)) +
    scale_fill_brewer(type = "qual", palette = 2) +
    
    scale_x_continuous(n.breaks = 3) +
    scale_y_continuous(n.breaks = 3) +
    
    labs(y = "Mean beta", x = "TR post stimtime", title = task.i) +
    theme(legend.position = "none")
  
  print(p.contrast)
  
  
  
  
  p.contrast.bivar <- d.contrast[task == task.i, .(b = mean(b)), by = .(run, network, tr, subj)] %>%
    
    dcast(... ~ run, value.var = "b") %>%
    
    ggplot(aes(run1, run2)) +
    geom_hline(yintercept = 0) +
    geom_vline(xintercept = 0) +
    geom_abline() +
    geom_point(shape = 21, fill = "black", color = "white", size = 2) +
    geom_point(
      data = . %>% group_by(network, tr) %>% summarize(run1 = mean(run1), run2 = mean(run2)),
      size = 2,
      color = "firebrick1"
      ) +
    
    scale_x_continuous(n.breaks = 3) +
    scale_y_continuous(n.breaks = 3) +
    
    facet_grid(vars(as.numeric(tr)), vars(network)) +
    labs(x = "run1 Mean beta contrast", y = "run2 Mean contrast", title = task.i) +
    theme(legend.position = "top")
  
  subchunkify(p.contrast.bivar, fig_height = 20, fig_width = 11.5)

  
}


```


### t-statistics


```{r network_stats}

d.network.stats <- 
    
  d.contrast[, .(b = mean(b)), by = .(task, run, network, tr, subj)] %>%
  
  group_by(task, network, tr, run) %>%
  summarize(t = t.test(b)$statistic, p = t.test(b)$p.value, b = mean(b)) %>%
  
  mutate(tr = as.numeric(tr))


for (task.i in tasks) {
  
  
  p.contrast.t <-
    
    d.network.stats %>% filter(task == task.i) %>%
    
    ggplot(aes(tr, t, color = run)) +
    geom_hline(yintercept = 2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = -2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = 0) +
  
    geom_line(size = 2) +
  
    facet_wrap(vars(network)) +
    scale_color_brewer(type = "qual", palette = 2) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    
    theme(legend.position = c(0.5, 0.15)) +
    labs(x = "TR post stimtime", y = "t-statistic of contrast", title = task.i)

  
  print(p.contrast.t)
  
  
}



```


# Parcel-level


## counts of significant effects per TR

Using t-test of subject parcel means, averaged across run.
Negative counts show deactivations.

```{r parcel_counts, results = "asis"}

d.parcel.stats <- 
    
  d.contrast[, .(b = mean(b)), by = .(task, parcel, network, tr, subj)] %>%
  
  group_by(task, parcel, network, tr) %>%
  summarize(t = t.test(b)$statistic, p = t.test(b)$p.value, b = mean(b)) %>%
  group_by(task, tr) %>%
  mutate(p.fdr = p.adjust(p, "fdr"), tr = as.numeric(tr))


d.parcel.counts <- 
  d.parcel.stats %>%
  group_by(task, tr, network) %>%
  summarize(
    nparc.activ = sum(b > 0 & p.fdr < 0.05),
    nparc.deactiv = -sum(b < 0 & p.fdr < 0.05)
    ) %>%
  reshape2::melt(id.var = c("tr", "network", "task"))



p.parcel.sum <-
  
  d.parcel.counts %>%
  
  group_by(tr, variable, task) %>% summarize(value = sum(value)) %>%
  
  ggplot(aes(tr, value, color = variable)) +
  geom_hline(yintercept = 0) +
  geom_point(size = 2) +
  geom_segment(aes(xend = tr, yend = 0), size = 1) +
  
  facet_grid(cols = vars(task), scales = "free_x") +
  scale_color_brewer(type = "qual", palette = 1) +
  theme(legend.position = "none") +
  
  scale_x_continuous(breaks = seq(0, 20, 4)) +
  scale_y_continuous(n.breaks = 15) +
  
  labs(
    y = "N parc w/ sig. hilo contrast\n (FDR corrected whole-cortex)", 
    x = "TR post stimtime", title = "number significant parcels by TR"
    )
  


p.parcel.sum.network <-
  
  d.parcel.counts %>%
  
    group_by(tr, variable, task, network) %>% summarize(value = sum(value)) %>%
    
    ggplot(aes(tr, value, color = variable)) +
    geom_hline(yintercept = 0) +
    geom_point(size = 2) +
    geom_segment(aes(xend = tr, yend = 0), size = 1) +
    
    facet_grid(vars(network), vars(task)) +
    scale_color_brewer(type = "qual", palette = 1) +
    theme(legend.position = "none") +
    
    scale_y_continuous(n.breaks = 5) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    
    labs(
      y = "N parc w/ sig. hilo contrast\n (FDR corrected whole-cortex)", 
      x = "TR post stimtime", title = "number significant parcels by TR"
      )


p.parcel.sum

subchunkify(p.parcel.sum.network, 12, 9)

```


## contrasts

### DMCC 34

#### beta estimates

```{r parcel_contrasts_betas, fig.height = 12, fig.width = 15}


for (task.i in tasks) {
  
  
  p.contrast.parcel <- 
    
    d.contrast[
      task == task.i & parcel %in% parcellation$key[dmcc34],
      .(b = mean(b)), by = .(run, parcel, tr, subj)
      ] %>%
    
    mutate(tr = as.numeric(tr)) %>%
    
    ggplot(aes(tr, b, fill = run)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", geom = "ribbon", alpha = 0.9) +
    
    facet_wrap(vars(parcel), scales = "free") +
    scale_fill_brewer(type = "qual", palette = 2) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +

    labs(y = "Mean beta", x = "TR post stimtime", title = task.i) +
    theme(legend.position = "none")
  
  print(p.contrast.parcel)

  
}


```


#### t-statistics

```{r parcel_contrasts_tstats, fig.height = 12, fig.width = 15}

d.parcel.stats <- 
  
  d.contrast[, .(b = mean(b)), by = .(task, parcel, tr, run, subj)] %>%
  
  group_by(task, parcel, tr, run) %>%
  summarize(t = t.test(b)$statistic, p = t.test(b)$p.value, b = mean(b)) %>%
  
  mutate(tr = as.numeric(tr))


for (task.i in tasks) {
  
  
  p.contrast.parcel.t <- 
    
    d.parcel.stats %>% 
    
    filter(task == task.i, parcel %in% parcellation$key[dmcc34]) %>%
    
    ggplot(aes(tr, t, color = run)) +
    geom_hline(yintercept = 2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = -2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = 0) +
  
    geom_line(size = 2) +
  
    facet_wrap(vars(parcel)) +
    scale_color_brewer(type = "qual", palette = 2) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    
    theme(legend.position = "none") +
    labs(x = "TR post stimtime", y = "t-statistic of contrast", title = task.i)
  
  
  print(p.contrast.parcel.t)

  
}


```



### Cross-task conjunction ("DMCC55B parcels")

Here conjunction analysis is performed by feeding TR-level contrast estimates to an HLM (see description at beginning of doc).

Number of parcels identified, and parcel names:

```{r parcelwise_stats}



group.target.trs <- enlist(tasks)
for (task.i in tasks) {
  
  
  d.task <- d.contrast[task == task.i & tr %in% target.trs[[task.i]]]
  d.task <- split(d.task, d.task$parcel)
  
  m.task <- lapply(d.task, function(x) lmer(b ~ 1 + (1 | subj), x))
  
  s.task <- bind_rows(lapply(m.task, tidy_lmer), .id = "parcel")
  s.task %<>% 
    ungroup %>%
    select(-term) %>% 
    mutate(
      p.fdr = p.adjust(p.value, "fdr"),
      hemi = substr(parcel, 1, 1),
      num.roi = row_number()
      )
  
  group.target.trs[[task.i]] <- s.task
  
}

group.target.trs <- bind_rows(group.target.trs, .id = "task")


group.target.trs %>% group_by(task) %>% 
  summarize(n.activated = sum(estimate > 0 & p.fdr < 0.05)) %>%
  kable


dmcc55b.parcels <- group.target.trs %>% filter(estimate > 0, p.fdr < 0.05) %>% pull(parcel) %>% table
dmcc55b.parcels <- names(dmcc55b.parcels)[dmcc55b.parcels == 4]

dmcc55b.parcels

```



### Curves of "DMCC55B parcels"



#### beta estimates

```{r parcel_contrasts_dmcc55b_betas, fig.height = 12, fig.width = 15}


for (task.i in tasks) {
  
  
  p.contrast.parcel.b.dmcc55b <- 
    
    d.contrast[
      task == task.i & parcel %in% dmcc55b.parcels,
      .(b = mean(b)), by = .(run, parcel, tr, subj)
      ] %>%
    
    mutate(tr = as.numeric(tr)) %>%
    
    ggplot(aes(tr, b, fill = run)) +
    geom_hline(yintercept = 0) +
    stat_summary(fun.data = "mean_cl_boot", geom = "ribbon", alpha = 0.9) +
    
    facet_wrap(vars(parcel)) +
    scale_fill_brewer(type = "qual", palette = 2) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +

    labs(y = "Mean beta", x = "TR post stimtime", title = task.i) +
    theme(legend.position = "none")
  
  print(p.contrast.parcel.b.dmcc55b)

  
}


```


#### t-statistics

```{r parcel_contrasts_dmcc55b_tstats, fig.height = 12, fig.width = 15}

d.parcel.stats <- 
  
  d.contrast[, .(b = mean(b)), by = .(task, parcel, tr, run, subj)] %>%
  
  group_by(task, parcel, tr, run) %>%
  summarize(t = t.test(b)$statistic, p = t.test(b)$p.value, b = mean(b)) %>%
  
  mutate(tr = as.numeric(tr))


for (task.i in tasks) {
  
  
  p.contrast.parcel.t <- 
    
    d.parcel.stats %>% 
    
    filter(task == task.i, parcel %in% dmcc55b.parcels) %>%
    
    ggplot(aes(tr, t, color = run)) +
    geom_hline(yintercept = 2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = -2, color = "grey50", linetype = "dashed") +
    geom_hline(yintercept = 0) +
  
    geom_line(size = 2) +
  
    facet_wrap(vars(parcel)) +
    scale_color_brewer(type = "qual", palette = 2) +
    scale_x_continuous(breaks = seq(0, 20, 4)) +
    
    theme(legend.position = "none") +
    labs(x = "TR post stimtime", y = "t-statistic of contrast", title = task.i)
  
  
  print(p.contrast.parcel.t)

  
}


```






## Brains (contrasts)

NB: colors are reversed (black = high, yellow = low) so large positive effects can be seen on white underlay.

```{r brains, fig.width = 15, results = "asis"}



for (task.i in tasks) {
  
  cat("\n ")
  cat(sprintf("\n### %s ", task.i))
  cat("\n ")

  
  group.target.trs %>%
    
    filter(task == task.i) %>%
    
    build_overlay("statistic", template = schaefer) %>%
    plot_surface(underlay = hcp, hues = rev(viridis::inferno(500)))
  
  
  group.target.trs %>%
    
    filter(task == task.i) %>%
    mutate(statistic = ifelse(p.fdr < 0.05, statistic, 0)) %>%
    
    build_overlay("statistic", template = schaefer) %>%
    plot_surface(underlay = hcp, hues = rev(viridis::inferno(500)))

    
}



```


```{r}

fwrite(group.target.trs, here("out", "stats_univ_hilo_target_schaefer400-07.csv"))

```



# Task Profiles across parcels



```{r}

# group.target.trs <- fread(here("out", "stats_univ_hilo_target_schaefer400-07.csv"))

parcel.order <- group.target.trs %>%
  
  filter(parcel %in% dmcc55b.parcels) %>%
  
  group_by(parcel) %>%
  summarize(b = mean(estimate)) %>%
  arrange(-b) %>%
  pull(parcel)

group.target.trs %>%
  
  filter(parcel %in% dmcc55b.parcels) %>%
  
  ggplot(aes(factor(parcel, levels = parcel.order), estimate, color = task)) +
  
  geom_line(aes(group = task), size = 2) +
  geom_point(size = 2.5) +
  geom_errorbar(
    aes(ymax = estimate + se*1.96, ymin = estimate - se*1.96), width = 0, size = 2
    ) +
  
  scale_color_brewer(type = "qual", palette = 7) +
  # scale_x_discrete()
  
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), legend.position = "top"
    ) +
  
  labs(x = NULL, y = "contrast estimate")


group.target.trs %>%
  
  filter(parcel %in% dmcc55b.parcels) %>%
  
  group_by(task) %>%
  mutate(estimate = scale(estimate)) %>%
  
  ggplot(aes(factor(parcel, levels = parcel.order), estimate, color = task)) +
  
  geom_line(aes(group = task), size = 2) +
  geom_point(size = 2.5) +
  # geom_errorbar(aes(ymax = estimate + se*1.96, ymin = estimate - se*1.96), width = 0) +
  
  scale_color_brewer(type = "qual", palette = 7) +
  
  theme(
    axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5), legend.position = "top"
    ) +
  
  labs(x = NULL, y = "z-scored contrast estimate")



```












